{% extends 'muban.html' %}
{% load static %}
{% block css %}
    <title>ç•™è¨€</title>
    <style>
        /* å¼¹å¹•è®¡æ•°æ ·å¼ */
        .danmu-count {
            position: absolute;
            bottom: 30px;
            left: 80px;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 20px;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .danmu-count:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .danmu-count::before {
            content: "ğŸ¯ ";
            margin-right: 5px;
        }
            .custom-message {
                position: fixed;
                top: 20px;
                left: 42%;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                text-align: center;
                min-width: 200px;
                max-width: 15%;  
                animation: slideDown 0.3s ease;
            }
            .message-success {
                background: linear-gradient(135deg, #4CAF50, #45a049);
                border: 1px solid #2e7d32;
            }
            .message-error {
                background: linear-gradient(135deg, #f44336, #d32f2f);
                border: 1px solid #b71c1c;
            }
            @keyframes slideDown {
                from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
        /* ç¡®ä¿bodyå’Œhtmlå¯ä»¥æ»šåŠ¨ */
        body, html {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            height: 100%;
            scroll-behavior: smooth;
        }

        /* å‘ä¸‹ç®­å¤´æ ·å¼ */
        .down-arrow {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            cursor: pointer;
            animation: bounce 2s infinite;
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .down-arrow:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-50%) scale(1.1);
        }

        .down-arrow .glyphicon-chevron-down {
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* å¼¹è·³åŠ¨ç”» */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(-10px);
            }
            60% {
                transform: translateX(-50%) translateY(-5px);
            }
        }

        /* å¼¹å¹•å®¹å™¨æ ·å¼ - é™åˆ¶åœ¨è¾“å…¥æ¡†ä¸Šæ–¹ */
        .danmu-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100vh - 250px); /* å‡å»è¾“å…¥æ¡†å’Œåº•éƒ¨ç©ºé—´ */
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        /* å•ä¸ªå¼¹å¹•æ ·å¼ */
        .danmu {
            position: absolute;
            white-space: nowrap;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            padding: 5px 15px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            pointer-events: none;
            animation: danmu-move 15s linear forwards;
            will-change: transform;
        }
        /* å¼¹å¹•å¤´åƒæ ·å¼ */
        .danmu-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            vertical-align: middle;
        }

        /* å¼¹å¹•æ–‡æœ¬æ ·å¼ */
        .danmu-text {
            vertical-align: middle;
            display: inline-block;
        }


        @keyframes danmu-move {
            from {
                transform: translateX(100vw);
            }
            to {
                transform: translateX(-100%);
            }
        }

        /* è¾“å…¥åŒºåŸŸæ ·å¼ */
        .danmu-input-container {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .danmu-input-group {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        #id_content {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            width: 100%;
            transition: all 0.3s ease;
        }

        #id_content:focus {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        #dmForm {
            width: 100%;
            display: flex;
            align-items: center;
        }

        .danmu-send-btn {
            margin: 0 15px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .danmu-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .danmu-send-btn:active {
            transform: translateY(0);
        }

        /* åŠ è½½æç¤º */
        .loading {
            color: white;
            text-align: center;
            padding: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* ä¸»å®¹å™¨æ ·å¼ */
        .container {
            position: relative;
            min-height: 100vh;
            width: 100%;
        }

        /* ç¬¬ä¸€ä¸ªå®¹å™¨ä¿æŒå…¨å±ä¸”ä¸æ»šåŠ¨ */
        .container:first-of-type {
            height: 100vh;
            overflow: hidden;
        }

        /* ç¬¬äºŒä¸ªå®¹å™¨æ ·å¼ - è¯„è®ºåŒº */
        .container:nth-of-type(2) {
         
            padding: 50px 20px;
            min-height: 100vh;
        }

        /* è¯„è®ºåŒºæ ·å¼ */
        .comments-section {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .comments-title {
            text-align: center;
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 30px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .comment-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .comment-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .comment-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
            outline: none;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            float: right;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .comments-list {
            margin-top: 30px;
        }

        .comment-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .comment-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .comment-time {
            color: #6c757d;
            font-size: 14px;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
            font-size: 15px;
        }

        .no-comments {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            font-size: 18px;
        }
        body{
            background: url('{% static 'img/d1.webp' %}') no-repeat;background-size: cover;width: 100%;height: 100vh;position: relative;
        }
        .user-card {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 8px 12px;
            border-radius: 25px;
            border: 1px solid #e0e0e0;
        }

        .user-info-card {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .username {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .user-badge {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        /* è¯„è®ºå¤´éƒ¨å¸ƒå±€ */
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .comment-time {
            color: #888;
            font-size: 12px;
            white-space: nowrap;
        }
        .user-info:hover .user-avatar {
            transform: scale(1.05);
            transition: transform 0.3s ease;
        }

        .user-info:hover .comment-author {
            color: #764ba2;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="danmu-count">å·²æœ‰{{count}}æ¡å¼¹å¹•äº†</div>
        <div class="down-arrow" onclick="scrollToNextSection()">
            <i class="fas fa-chevron-down" aria-hidden="true" style="color:white;"></i>
        </div>
        <!-- å¼¹å¹•å®¹å™¨ -->
        <div class="danmu-container" id="danmuContainer">
            <div class="loading">å¼¹å¹•åŠ è½½ä¸­...</div>
        </div>

        <!-- å¼¹å¹•è¾“å…¥æ¡† -->
        <div class="danmu-input-container">
            <div class="danmu-input-group">
                <form id="dmForm">
                    {% csrf_token %}
                    {{ form.content }}
                    <button type="button" class="danmu-send-btn" id="danmuSendBtn">å‘é€å¼¹å¹•</button>
                </form>
            </div>
        </div>

    </div>


    <div class="container">
        <div class="comments-section" style="margin-top: 65px;">
            <h2 class="comments-title">ç”¨æˆ·ç•™è¨€åŒº | å…±{{com_count}}æ¡ç•™è¨€</h2>
            
            {% if not request.session.user_id %}
            <div class="comment-form">
                <p style="font-size: 18px;">è¯·å…ˆ<a href="/index/login/">ç™»å½•</a>åå†æ¥ç•™è¨€~~~</p>
            </div>
            {% endif %}
            
            {% if request.session.user_id %}
            <div class="comment-form">
                <textarea class="comment-input" id="commentInput" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..."></textarea>
                <button class="submit-btn" id="submitComment">å‘è¡¨ç•™è¨€</button>
                <div style="clear: both;"></div>
            </div>
            {% endif %}
            
           <div class="comments-list" id="commentsList">
               {% for comment in data %}
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="user-card">
                             <img src="/media/avatars/avatar_{{ comment.user_id.id }}.jpg"
                                    style="width: 35px; height: 35px; object-fit: cover; border-radius: 50%; margin-right: 5px;"
                                    onerror="this.style.display='none'"
                                    alt="å¤´åƒ" />
                            <div class="user-info-card">
                                <span class="username">{{ comment.user_id.username }}</span>
                                {% if comment.user_id.role == 1 %}
                                <span class="user-badge">#ç®¡ç†å‘˜</span>
                                {% else %}
                                <span class="user-badge">#ç”¨æˆ·</span>

                                {% endif %}
                            </div>
                        </div>
                        <span class="comment-time">{{ comment.date|date:"Y-m-d H:i" }}</span>
                    </div>
                    <div class="comment-content">
                       {{ comment.content }}
                    </div>
                </div>
                {% endfor %}
                   <ul class="pagination">
                       {{ page_string }}
                   </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script>
    function scrollToNextSection() {
        console.log('ç‚¹å‡»äº†å‘ä¸‹ç®­å¤´');
        const containers = document.querySelectorAll('.container');
        console.log('æ‰¾åˆ°çš„containeræ•°é‡:', containers.length);

        if (containers.length > 1) {
            const nextSection = containers[1];
            console.log('æ‰¾åˆ°çš„ä¸‹ä¸€ä¸ªsection:', nextSection);

            nextSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        } else {
            console.log('æœªæ‰¾åˆ°ä¸‹ä¸€ä¸ªsectionï¼Œcontaineræ•°é‡:', containers.length);
        }
    }

    $(document).ready(function() {

        // å‘ä¸‹ç®­å¤´ç‚¹å‡»äº‹ä»¶
        $('.down-arrow').on('click', function() {
            scrollToNextSection();
        });

        // ========== å¼¹å¹•åŠŸèƒ½ ==========
        const danmuContainer = $('#danmuContainer');
        const danmuInput = $('#id_content');
        const danmuSendBtn = $('#danmuSendBtn');
        const csrfToken = $('[name=csrfmiddlewaretoken]').val();

        // å¼¹å¹•é¢œè‰²æ•°ç»„
        const colors = [
            '#FFFFFF', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
            '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE'
        ];

        // å­—ä½“å¤§å°æ•°ç»„
        const fontSizes = [16, 18, 20, 22, 24];

        // å­˜å‚¨æ´»è·ƒçš„å¼¹å¹•ä¿¡æ¯
        let activeDanmus = [];
        // å¼¹å¹•è½¨é“ç³»ç»Ÿ - å°†å±å¹•åˆ†ä¸ºå¤šä¸ªè½¨é“
        const tracks = Array(8).fill(0); // 8ä¸ªè½¨é“ï¼Œè®°å½•æ¯ä¸ªè½¨é“çš„ç»“æŸæ—¶é—´

        // åˆ›å»ºå¼¹å¹•å…ƒç´ çš„ç‹¬ç«‹å‡½æ•°
        function createDanmuElement(text, userInfo) {
            // è®¡ç®—å¼¹å¹•å®½åº¦å’Œé€Ÿåº¦
            const tempSpan = $('<span>').text(text).css({
                'font-size': '18px',
                'font-weight': 'bold',
                'visibility': 'hidden',
                'position': 'absolute'
            }).appendTo('body');

            const textWidth = tempSpan.width();
            tempSpan.remove();

            // è®¡ç®—å¼¹å¹•ç§»åŠ¨æ—¶é—´
            const screenWidth = $(window).width();
            const distance = screenWidth + textWidth;
            const duration = (distance / screenWidth) * 15;

            // é€‰æ‹©å¯ç”¨çš„è½¨é“
            let availableTrack = -1;
            const currentTime = Date.now();

            for (let i = 0; i < tracks.length; i++) {
                if (currentTime >= tracks[i]) {
                    availableTrack = i;
                    break;
                }
            }

            if (availableTrack === -1) {
                availableTrack = tracks.indexOf(Math.min(...tracks));
            }

            // è®¡ç®—è½¨é“ä½ç½®
            const trackHeight = danmuContainer.height() / tracks.length;
            const top = (availableTrack * trackHeight) + (trackHeight / 2);

            // æ›´æ–°è½¨é“å ç”¨æ—¶é—´
            tracks[availableTrack] = currentTime + (duration * 1000);

            // åˆ›å»ºå¼¹å¹•å®¹å™¨
            const danmu = $('<div class="danmu"></div>');
            
            // æ·»åŠ å¤´åƒï¼ˆå¦‚æœç”¨æˆ·æœ‰å¤´åƒï¼‰
            if (userInfo && userInfo.has_avatar && userInfo.user_id) {
                const avatar = $('<img class="danmu-avatar">');
                avatar.attr('src', `/media/avatars/avatar_${userInfo.user_id}.jpg?t=${new Date().getTime()}`);
                avatar.attr('alt', userInfo.username);
                avatar.on('error', function() {
                    $(this).remove(); // å¦‚æœå¤´åƒåŠ è½½å¤±è´¥ï¼Œç§»é™¤å¤´åƒ
                });
                danmu.append(avatar);
            }

            // æ·»åŠ æ–‡æœ¬å†…å®¹
            const textSpan = $('<span class="danmu-text"></span>').text(text);
            danmu.append(textSpan);

            // è®¾ç½®æ ·å¼
            const color = colors[availableTrack % colors.length];
            const fontSize = fontSizes[availableTrack % fontSizes.length];

            danmu.css({
                'top': top + 'px',
                'animation-duration': duration + 's'
            });

            textSpan.css({
                'color': color,
                'font-size': fontSize + 'px'
            });

            // æ·»åŠ åˆ°å®¹å™¨
            danmuContainer.append(danmu);

            // å­˜å‚¨å¼¹å¹•ä¿¡æ¯
            const danmuInfo = {
                element: danmu[0],
                track: availableTrack,
                startTime: currentTime,
                duration: duration * 1000
            };
            activeDanmus.push(danmuInfo);

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                danmu.remove();
                activeDanmus = activeDanmus.filter(d => d.element !== danmu[0]);
            }, duration * 1000);
        }

        // å‘é€å¼¹å¹•å‡½æ•°
        function sendDanmu(text, userInfo = null, isNew = false) {
            if (!text.trim()) return;

            // å¦‚æœæ˜¯æ–°å¼¹å¹•ï¼Œä¿å­˜åˆ°æ•°æ®åº“
            if (isNew) {
                $.ajax({
                    url: '/send_danmu/',
                    type: 'POST',
                    dataType: 'json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    data: JSON.stringify({
                        'content': text
                    }),
                    contentType: 'application/json',
                    success: function(data) {
                        if (data.status) {
                            console.log('å¼¹å¹•ä¿å­˜æˆåŠŸ:', data.content);
                            danmuInput.val('');
                            
                            // ä½¿ç”¨å½“å‰ç”¨æˆ·ä¿¡æ¯åˆ›å»ºå¼¹å¹•
                            const currentUserInfo = {
                                user_id: {{ request.session.user_id|default:"0" }},
                                username: '{{ request.session.username|default:"æ¸¸å®¢" }}',
                                has_avatar: true
                            };
                            createDanmuElement(text, currentUserInfo);
                        } else {
                            alert('å‘é€å¤±è´¥: ' + data.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('å‘é€å¼¹å¹•å¤±è´¥:', error);
                        alert('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                });
            } else {
                // å†å²å¼¹å¹•ä½¿ç”¨ä¼ å…¥çš„ç”¨æˆ·ä¿¡æ¯
                createDanmuElement(text, userInfo);
            }
        }

        // å¼¹å¹•å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        danmuSendBtn.on('click', function() {
            const text = danmuInput.val().trim();
            if (text) {
                // ç«‹å³æ˜¾ç¤ºå¼¹å¹•
                const currentUserInfo = {
                    user_id: {{ request.session.user_id|default:"0" }},
                    username: '{{ request.session.username|default:"æ¸¸å®¢" }}',
                    has_avatar: true
                };
                createDanmuElement(text, currentUserInfo);
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                $.ajax({
                    url: '/send_danmu/',
                    type: 'POST',
                    dataType: 'json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    data: JSON.stringify({
                        'content': text
                    }),
                    contentType: 'application/json',
                    success: function(data) {
                        if (data.status) {
                            danmuInput.val('');
                        } else {
                            console.error('å¼¹å¹•ä¿å­˜å¤±è´¥:', data.error);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('å‘é€å¼¹å¹•å¤±è´¥:', error);
                    }
                });
            } else {
                alert('è¯·è¾“å…¥å¼¹å¹•å†…å®¹');
            }
        });

        // å¼¹å¹•å›è½¦é”®å‘é€
        danmuInput.on('keypress', function(e) {
            if (e.which === 13) {
                e.preventDefault();
                const text = danmuInput.val().trim();
                if (text) {
                    // ç«‹å³æ˜¾ç¤ºå¼¹å¹•
                    const currentUserInfo = {
                        user_id: {{ request.session.user_id|default:"0" }},
                        username: '{{ request.session.username|default:"æ¸¸å®¢" }}',
                        has_avatar: true
                    };
                    createDanmuElement(text, currentUserInfo);
                    
                    // ä¿å­˜åˆ°æ•°æ®åº“
                    $.ajax({
                        url: '/send_danmu/',
                        type: 'POST',
                        dataType: 'json',
                        headers: {
                            'X-CSRFToken': csrfToken
                        },
                        data: JSON.stringify({
                            'content': text
                        }),
                        contentType: 'application/json',
                        success: function(data) {
                            if (data.status) {
                                danmuInput.val('');
                            } else {
                                console.error('å¼¹å¹•ä¿å­˜å¤±è´¥:', data.error);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('å‘é€å¼¹å¹•å¤±è´¥:', error);
                        }
                    });
                }
            }
        });

        // ä»æœåŠ¡å™¨åŠ è½½å†å²å¼¹å¹•
        function loadHistoryDanmus() {
            $.ajax({
                url: '/get_danmus/',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.status && data.danmus) {
                        danmuContainer.find('.loading').remove();
                        data.danmus.forEach((danmu, index) => {
                            setTimeout(() => {
                                createDanmuElement(danmu.content, {
                                    user_id: danmu.user_id,
                                    username: danmu.username,
                                    has_avatar: danmu.has_avatar
                                });
                            }, index * 800);
                        });
                    }
                },
                error: function(xhr, status, error) {
                    danmuContainer.find('.loading').text('åŠ è½½å¼¹å¹•å¤±è´¥,è¯·å…ˆç™»é™†åæŸ¥çœ‹');
                }
            });
        }

        // è°ƒæ•´å¼¹å¹•å®¹å™¨å¤§å°
        function resizeDanmuContainer() {
            danmuContainer.height($(window).height() - 250);
        }

        $(window).on('resize', resizeDanmuContainer);
        resizeDanmuContainer();

        // é¡µé¢åŠ è½½åå¼€å§‹åŠ è½½å†å²å¼¹å¹•
        setTimeout(loadHistoryDanmus, 1000);

        // å¼¹å¹•å¾ªç¯æ’­æ”¾
        function startDanmuLoop() {
            $.ajax({
                url: '/get_danmus/',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if (data.status && data.danmus) {
                        const danmusWithUserInfo = data.danmus.map(d => ({
                            content: d.content,
                            userInfo: {
                                user_id: d.user_id,
                                username: d.username,
                                has_avatar: d.has_avatar
                            }
                        }));
                        
                        let index = 0;

                        function playNextDanmu() {
                            if (index >= danmusWithUserInfo.length) {
                                index = 0;
                            }

                            const danmu = danmusWithUserInfo[index];
                            createDanmuElement(danmu.content, danmu.userInfo);
                            index++;

                            // éšæœºå»¶è¿Ÿï¼Œé¿å…è¿‡äºå¯†é›†
                            setTimeout(playNextDanmu, Math.random() * 3000 + 2000);
                        }

                        // å»¶è¿Ÿå¼€å§‹æ’­æ”¾
                        setTimeout(playNextDanmu, 5000);
                    }
                }
            });
        }

        // åœ¨é¡µé¢åŠ è½½åè°ƒç”¨
        setTimeout(startDanmuLoop, 2000);

        $('#submitComment').off('click');
        $('#commentInput').off('keypress');
        $('.submit-btn').off('click');

        $('#submitComment').on('click', function() {

            const commentText = $('#commentInput').val().trim();

            if (!commentText) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = $(this);
            const originalText = submitBtn.text();
            submitBtn.text('å‘é€ä¸­...').prop('disabled', true);

            $.ajax({
                url: '/send_comment/',
                type: 'POST',
                dataType: 'json',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                data: JSON.stringify({
                    'content': commentText
                }),
                contentType: 'application/json',
                success: function(data) {
                    console.log('æœåŠ¡å™¨å“åº”:', data);

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.text(originalText).prop('disabled', false);

                    if (data.status) {
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        $('#commentInput').val('');

                        // æ·»åŠ æ–°ç•™è¨€åˆ°åˆ—è¡¨
                        const newComment = `
                            <div class="comment-item">
                                <div class="comment-header">
                                    <div class="user-card">
                                        <img src="/media/avatars/avatar_{{request.session.user_id}}.jpg"
                                            style="width: 35px; height: 35px; object-fit: cover; border-radius: 50%; margin-right: 5px;"
                                            onerror="this.style.display='none'"
                                            alt="å¤´åƒ" />
                                        <div class="user-info-card">
                                            <span class="username">${data.comment.username}</span>
                                            ${data.comment.role === 1 ? 
                                                '<span class="user-badge">#ç®¡ç†å‘˜</span>' : 
                                                '<span class="user-badge">#ç”¨æˆ·</span>'
                                            }
                                        </div>
                                    </div>
                                    <span class="comment-time">${data.comment.date}</span>
                                </div>
                                <div class="comment-content">
                                    ${data.comment.content}
                                </div>
                            </div>
                        `;

                        // ç§»é™¤"æš‚æ— ç•™è¨€"æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        $('.no-comments').remove();

                        // æ·»åŠ æ–°ç•™è¨€åˆ°åˆ—è¡¨é¡¶éƒ¨
                        $('#commentsList').prepend(newComment);

                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showMessage('ç•™è¨€å‘è¡¨æˆåŠŸï¼', 'success');
                    } else {
                        showMessage('å‘è¡¨å¤±è´¥: ' + data.error, 'error');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('å‘è¡¨ç•™è¨€å¤±è´¥:', error);
                    console.error('å“åº”çŠ¶æ€:', xhr.status);
                    console.error('å“åº”æ–‡æœ¬:', xhr.responseText);

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.text(originalText).prop('disabled', false);

                    showMessage('å‘è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                }
            });
        });

        // ç•™è¨€å›è½¦é”®æäº¤
        $('#commentInput').on('keypress', function(e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                $('#submitComment').click();
            }
        });

        // æ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•°
        function showMessage(message, type) {
            // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
            $('.custom-message').remove();

            const messageClass = type === 'success' ? 'message-success' : 'message-error';
            const messageHtml = `
                <div class="custom-message ${messageClass}">
                    ${message}
                </div>
            `;

            $('body').append(messageHtml);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                $('.custom-message').fadeOut(300, function() {
                    $(this).remove();
                });
            }, 3000);
        }

        // æ·»åŠ æ¶ˆæ¯æ ·å¼
        if (!$('#message-styles').length) {
            $('head').append(`
                <style id="message-styles">
                    .custom-message {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 15px 20px;
                        border-radius: 8px;
                        color: white;
                        font-weight: bold;
                        z-index: 10000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        animation: slideIn 0.3s ease;
                    }
                    .message-success {
                        background: linear-gradient(135deg, #4CAF50, #45a049);
                    }
                    .message-error {
                        background: linear-gradient(135deg, #f44336, #d32f2f);
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                </style>
            `);
        }

        console.log('æ‰€æœ‰åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
    });

    // ä¿®æ”¹æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
    function showMessage(message, type) {
        // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
        $('.custom-message').remove();

        const messageClass = type === 'success' ? 'message-success' : 'message-error';
        const messageHtml = `
            <div class="custom-message ${messageClass}">
                ${message}
            </div>
        `;

        $('body').append(messageHtml);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            $('.custom-message').fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }

    // æ·»åŠ é¡µé¢å¸è½½å‰çš„æ¸…ç†
    $(window).on('beforeunload', function() {
        console.log('é¡µé¢å¸è½½ï¼Œæ¸…ç†èµ„æº...');
    });
</script>
{% endblock %}