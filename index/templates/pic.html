{% extends 'muban.html' %}
{% load static %}
{% block css %}
    <title>ç›¸å†Œ</title>
    <style>
        /* é¡µé¢èƒŒæ™¯ */
        body {
            background: url('{% static 'img/111.jpg' %}') no-repeat center center fixed;
            background-size: 100% 100%;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* ç›¸å†Œé¡µé¢ç‰¹å®šæ ·å¼ */
        .gallery-container {
            padding: 100px 20px 50px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .gallery-title {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            position: relative;
            padding-bottom: 15px;
        }

        .gallery-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(to right, transparent, orange, transparent);
        }

        .gallery-description {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 40px;
            font-size: 1.8rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }

        /* æ·»åŠ å›¾ç‰‡æŒ‰é’®æ ·å¼ */
        .add-photo-btn-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .add-photo-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .add-photo-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .add-photo-btn:active {
            transform: translateY(-1px);
        }

        .add-photo-btn i {
            font-size: 1.2rem;
        }

        /* ç€‘å¸ƒæµå¸ƒå±€ */
        .masonry-grid {
            column-count: 4;
            column-gap: 15px;
        }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            background: white;
        }

        .masonry-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .masonry-img {
            width: 100%;
            display: block;
            transition: transform 0.5s ease;
        }

        .masonry-item:hover .masonry-img {
            transform: scale(1.05);
        }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            color: white;
            padding: 20px 15px 10px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .masonry-item:hover .image-overlay {
            transform: translateY(0);
        }

        .image-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .image-date {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        /* ä¿®å¤æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    overflow-y: auto; /* å…è®¸æ¨¡æ€æ¡†æ»šåŠ¨ */
}

.modal-dialog {
    margin: 2% auto; /* å‡å°‘é¡¶éƒ¨é—´è· */
    max-height: 90vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
}

.modal-content {
    max-height: 90vh; /* é™åˆ¶å†…å®¹é«˜åº¦ */
    overflow: hidden; /* éšè—æº¢å‡º */
}

.modal-body {
    max-height: calc(90vh - 120px); /* è®¡ç®—åˆé€‚çš„é«˜åº¦ */
    overflow-y: auto; /* å…è®¸å†…å®¹æ»šåŠ¨ */
    padding: 20px;
}

/* ç¡®ä¿å›¾ç‰‡åœ¨æ¨¡æ€æ¡†ä¸­æ­£ç¡®æ˜¾ç¤º */
.modal-image {
    max-width: 100%;
    max-height: 400px; /* é™åˆ¶å›¾ç‰‡æœ€å¤§é«˜åº¦ */
    object-fit: contain; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
    display: block;
    margin: 0 auto;
}
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-content {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(to right, #83a9f8, #b0b9ff);
            color: white;
            border-bottom: none;
        }

        .modal-header .close {
            color: white;
            opacity: 0.8;
        }

        .modal-header .close:hover {
            opacity: 1;
        }

        .modal-image {
            width: 100%;
            border-radius: 0;
        }

        .image-modal-title {
            font-weight: bold;
            margin-top: 15px;
            color: #213562;
        }

        .image-modal-description {
            color: #213562;
            margin-top: 10px;
            line-height: 1.5;
        }

        /* æ·»åŠ å›¾ç‰‡çš„æ¨¡æ€æ¡†æ ·å¼ */
        .upload-modal .modal-header {
            background: linear-gradient(to right, #667eea, #764ba2);
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9fa;
        }

        .upload-area i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 992px) {
            .masonry-grid {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .masonry-grid {
                column-count: 2;
            }

            .gallery-title {
                font-size: 2rem;
            }

            .add-photo-btn {
                padding: 10px 25px;
                font-size: 1rem;
            }
        }

        @media (max-width: 576px) {
            .masonry-grid {
                column-count: 1;
            }

            .gallery-container {
                padding: 80px 15px 30px;
            }

            .add-photo-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="gallery-container">
        <h1 class="gallery-title">æˆ‘çš„ç›¸å†Œ</h1>
        <p class="gallery-description">
            è®°å½•ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´,åˆ†äº«ä¸€äº›å¥½çœ‹çš„å›¾ç‰‡~</p>

        <!-- æ·»åŠ å›¾ç‰‡æŒ‰é’® -->
        {% if request.session.role == 1 %}

        <div class="add-photo-btn-container">
            <button class="add-photo-btn" data-toggle="modal" data-target="#uploadModal">
                <i>+</i> æ·»åŠ å›¾ç‰‡
            </button>
        </div>
        {% endif %}
        <div class="masonry-grid">

            {% for i in pictures %}
                <div class="masonry-item" data-toggle="modal" data-target="#imageModal{{ i.id }}">
                    <img src="/{{ i.path }}" alt="{{ i.title }}" class="masonry-img">
                    <div class="image-overlay">
                        <div class="image-title">{{ i.title }}</div>
                        <div class="image-date">{{ i.date|date:"Yå¹´mæœˆdæ—¥" }}</div>
                    </div>
                </div>
            {% endfor %}

        </div>
        <ul class="pagination">
            {{ page_string }}
        </ul>
    </div>

    <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
    <!-- æ¨¡æ€æ¡†1 -->
    {% for i in pictures %}
    <div class="modal fade" id="imageModal{{ i.id }}" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel{{ i.id }}"
         aria-hidden="true" style="margin-top: 5%" >
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                     <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>

                    <h4 class="modal-title" id="imageModalLabel1">{{ i.title }}</h4>
                </div>
                <div class="modal-body">
                    <img src="/{{ i.path }}" alt="{{ i.title }}" class="modal-image">
                    <h5 class="image-modal-title">{{ i.description }}</h5>
                    <p class="image-modal-description" style="float:right">
                        {{ i.date|date:"Yå¹´mæœˆdæ—¥" }}</p>
                    {% if request.session.role == 1 %}
                    <button id="delte_pic" uid = "{{ i.id }}" class="btn btn-danger" type="button" >åˆ  é™¤</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- æ·»åŠ å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div class="modal fade upload-modal" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="uploadModalLabel">æ·»åŠ æ–°å›¾ç‰‡</h4>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                            {% csrf_token %}

                        <!-- ä¸Šä¼ åŒºåŸŸ -->
                        <div class="upload-area">
                            <label for="imageUpload"
                                   style="display: block; cursor: pointer; padding: 40px 20px; margin: 0; text-align: center;">
                                <i>ğŸ“</i>
                                <h5>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</h5>
                                <p class="text-muted">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
                            </label>
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        </div>

                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                        <div id="imagePreview" style="display: none; text-align: center; margin-bottom: 20px;">
                            <img id="previewImg" src="" alt="é¢„è§ˆå›¾" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                        </div>

                        <!-- è¡¨å•å­—æ®µ -->
                        <div class="form-group">
                            <label for="imageTitle">å›¾ç‰‡æ ‡é¢˜</label>
                            <input type="text" class="form-control" id="imageTitle" placeholder="è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜">
                        </div>

                        <div class="form-group">
                            <label for="imageDescription">å›¾ç‰‡æè¿°</label>
                            <textarea class="form-control" id="imageDescription" rows="3" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="imageDate">æ‹æ‘„æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="imageDate">
                            <p style="font-size: 12px;color: red;">chromeä»¥å¤–æµè§ˆå™¨å¯èƒ½æ—¥æœŸæœ‰BUGï¼Œç‚¹å‡»å³ä¾§å°æ—¥å†é€‰æ‹©å³å¯</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveImageBtn">ä¿å­˜å›¾ç‰‡</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

  {% block js %}
    <script>
        $(function() {
            delete_picture();
        })

        // å›¾ç‰‡åˆ é™¤
        function delete_picture() {
            $('#delte_pic').on('click', function(){
                var nid = $(this).attr('uid')
                $.ajax({
                    url:"/delete_pic/",
                    type: "GET",
                    data:{
                        'nid': nid
                    },
                    dataType:"json",
                    success:function(data){
                        if(data.status){
                            alert("åˆ é™¤æˆåŠŸ");
                            //åˆ·æ–°é¡µé¢
                            location.reload();
                        }
                    }
                })
            })
        }

        $(document).ready(function () {
            // å›¾ç‰‡åŠ è½½å®Œæˆåé‡æ–°æ’åˆ—ç€‘å¸ƒæµ
            $('.masonry-img').on('load', function () {
                setTimeout(function () {
                    $('.masonry-grid').css('column-count', '4');
                }, 100);
            });

            // ç‚¹å‡»å›¾ç‰‡æ—¶æ˜¾ç¤ºæ¨¡æ€æ¡†
            $('.masonry-item').click(function (e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                var target = $(this).data('target');

                $(target).modal('show');
            });

            // ä¸Šä¼ å›¾ç‰‡åŠŸèƒ½
            $('#uploadArea').click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('#imageUpload').trigger('click'); // ç¡®ä¿è§¦å‘ç‚¹å‡»
            });

            // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
            $('#imageUpload').change(function(e) {
                var file = e.target.files[0];
                if (file) {
                    // æ–‡ä»¶ç±»å‹éªŒè¯
                    var validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(file.type)) {
                        alert('è¯·ä¸Šä¼  JPGã€PNG æˆ– GIF æ ¼å¼çš„å›¾ç‰‡');
                        $(this).val(''); // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                        return;
                    }

                    // æ–‡ä»¶å¤§å°éªŒè¯ (5MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                        $(this).val(''); // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                        return;
                    }

                    var reader = new FileReader();
                    reader.onload = function(e) {
                        $('#previewImg').attr('src', e.target.result);
                        $('#imagePreview').show();
                    }
                    reader.readAsDataURL(file);
                }
            });

            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            $('#uploadArea').on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).css({
                    'border-color': '#667eea',
                    'background-color': '#f8f9fa'
                });
            });

            $('#uploadArea').on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).css({
                    'border-color': '#ccc',
                    'background-color': 'transparent'
                });
            });

            $('#uploadArea').on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    $('#imageUpload')[0].files = files;
                    $('#imageUpload').trigger('change');
                }
                $(this).css({
                    'border-color': '#ccc',
                    'background-color': 'transparent'
                });
            });

            // ä¿å­˜å›¾ç‰‡åŠŸèƒ½ - ä½¿ç”¨AJAXä¸Šä¼ 
            $('#saveImageBtn').click(function(e) {
    e.preventDefault(); // ä½¿ç”¨ preventDefault è€Œä¸æ˜¯ stopPropagation

    var title = $('#imageTitle').val();
    var description = $('#imageDescription').val();
    var date = $('#imageDate').val();
    var file = $('#imageUpload')[0].files[0];

    if (!file) {
        alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
        return;
    }

    if (!title) {
        alert('è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜');
        return;
    }

    // è·å– CSRF token
    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    // åˆ›å»ºFormDataå¯¹è±¡
    var formData = new FormData();
    formData.append('image', file);
    formData.append('title', title);
    formData.append('description', description);
    if (date) {
        formData.append('capture_date', date);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    var $btn = $(this);
    $btn.prop('disabled', true).text('ä¸Šä¼ ä¸­...');

    // AJAXä¸Šä¼ 
    $.ajax({
        url: '/upload_pic/',  // ç¡®ä¿è¿™ä¸ªURLæ­£ç¡®
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': csrfToken  // æ·»åŠ  CSRF token åˆ°è¯·æ±‚å¤´
        },
        success: function(response) {
            console.log('ä¸Šä¼ å“åº”:', response); // æ·»åŠ æ—¥å¿—
            if (response.status === 'success') {
                alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                $('#uploadModal').modal('hide');

                // é‡ç½®è¡¨å•
                $('#uploadForm')[0].reset();
                $('#imagePreview').hide();

                // å¯é€‰ï¼šåˆ·æ–°é¡µé¢æˆ–åŠ¨æ€æ·»åŠ æ–°å›¾ç‰‡
                location.reload(); // ç®€å•åˆ·æ–°é¡µé¢
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('ä¸Šä¼ é”™è¯¯:', error, xhr.responseText);
            alert('ä¸Šä¼ å‡ºé”™: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
        },
        complete: function() {
            $btn.prop('disabled', false).text('ä¿å­˜å›¾ç‰‡');
        }
    });
});
        });
    </script>
{% endblock %}