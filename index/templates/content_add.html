{% extends 'muban.html' %}
{% load static %}

{% block css %}
    <title>{{title}}</title>
    {{ form.media }}
    <style>
        /* æ–°å¢ï¼šMarkdown å¯¼å…¥åŠŸèƒ½æ ·å¼ */
        .import-markdown-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px dashed #667eea;
            transition: all 0.3s ease;
        }

        .import-markdown-section:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #764ba2;
        }

        .import-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: #333;
            font-weight: bold;
        }

        .import-header i {
            margin-right: 10px;
            color: #667eea;
            font-size: 18px;
        }

        .import-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-import {
            background: linear-gradient(135deg, #48c78e 0%, #00d1b2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-import:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(72, 199, 142, 0.3);
        }

        .import-file-input {
            display: none;
            height: 50px;
        }

        .file-info {
            color: #666;
            font-size: 14px;
            margin-left: 10px;
        }

        .import-options {
            margin-top: 15px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 8px;
            display: none;
        }

        .import-options.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .option-group {
            margin-bottom: 10px;
        }

        .option-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #333;
            font-size: 14px;
        }

        .import-preview {
            margin-top: 15px;
            padding: 15px;
            background: rgba(248, 249, 250, 0.9);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .import-preview.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .preview-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .preview-content {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            max-height: 120px;
            overflow: hidden;
        }

        .preview-content.expanded {
            max-height: none;
            overflow-y: auto;
        }

        .preview-actions {
            margin-top: 10px;
            text-align: right;
        }

        .btn-preview-toggle {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }
            to { 
                opacity: 1;
                transform: translateY(0);
                max-height: 200px;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .import-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-import {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .file-info {
                margin-left: 0;
                text-align: center;
            }
        }
        /* æ–‡ä»¶ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        .file-input-wrapper {
            margin-bottom: 15px;
        }

        .btn-upload {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .cover-preview-container {
            margin-top: 15px;
        }

        .cover-preview {
            max-width: 500px !important;
            max-height: 300px !important;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .cover-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* éšè—Djangoé»˜è®¤çš„æ–‡ä»¶è¾“å…¥æ ·å¼ */
        input[type="file"][name="cover_img"] {
            display: none !important;
        }
        /* mdeditor å¼¹çª—å±…ä¸­ä¿®å¤ */
        .editormd-dialog {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 10050 !important;
            max-height: 500px !important;
            height: auto !important;
            background: white !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
        }

        .editormd-dialog-container {
            z-index: 10049 !important;
            background: rgba(0, 0, 0, 0.5) !important;
        }

        .editormd-dialog-body {
            max-height: 400px !important;
            overflow-y: auto !important;
        }

        /* ç¡®ä¿ç¼–è¾‘å™¨æ­£ç¡®æ˜¾ç¤º */
        .editormd {
            z-index: 1000 !important;
        }

        /* æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡†æ ·å¼ */
        input[type="file"] {
            padding: 5px 15px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            background-color: #e9ecef;
        }

        input[type="file"]::file-selector-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        input[type="file"]::file-selector-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        /* æ–‡ç« ç¼–è¾‘é¡µé¢ä¸“ç”¨æ ·å¼ */
        .article-edit-container {
            padding-top: 100px;
            min-height: 100vh;
            background: url({% static 'img/d3.png' %}) no-repeat center center fixed;
            background-size: cover;
            padding-bottom: 50px;
        }

        .article-form-container {
            background-color: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            padding: 40px;
            margin: 0 auto;
            max-width: 1200px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .form-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #e9ecef;
        }

        .form-header h2 {
            color: #333;
            font-weight: bold;
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 30px;
            position: relative;
        }

        .control-label {
            color: #333;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            display: block;
        }

        /* æ–‡æœ¬è¾“å…¥æ¡†ç‰¹å®šæ ·å¼ */
        input[type="text"] {
            height: 50px;
        }

        /* æ–‡æœ¬åŒºåŸŸç‰¹å®šæ ·å¼ */
        textarea {
            min-height: 400px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        textarea:focus {
            min-height: 450px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            padding: 12px 40px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:active {
            transform: translateY(-1px);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            padding: 12px 40px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
            cursor: pointer;
        }

        .btn-cancel:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.4);
        }

        /* è¡¨å•åŠ¨ä½œåŒºåŸŸ */
        .form-actions {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }

        /* å°é¢å›¾ç‰‡æ ·å¼ */
        #id_cover_img {
            height: 45px;
        }

        .cover-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .cover-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* å­—ç¬¦è®¡æ•° */
        .char-count {
            text-align: right;
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
            font-weight: 500;
        }

        /* è¾“å…¥æ¡†åŠ¨ç”» */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            animation: slideIn 0.5s ease forwards;
        }

        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }
        .form-group:nth-child(5) { animation-delay: 0.5s; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .article-edit-container {
                padding-top: 80px;
                padding-left: 15px;
                padding-right: 15px;
            }

            .article-form-container {
                padding: 20px;
            }

            .form-header h2 {
                font-size: 2rem;
            }

            textarea {
                min-height: 300px;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .btn-submit, .btn-cancel {
                padding: 10px 30px;
                font-size: 14px;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="article-edit-container">
        <div class="container">
            <div class="article-form-container">
                <div class="form-header">
                    <h2><i class="fa fa-align-center" aria-hidden="true"></i> {{title}}</h2>
                </div>

                <form id="articleForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ·»åŠ éšè—å­—æ®µ -->
                    {% if form.instance.id %}
                    <input type="hidden" name="edit_mode" value="true">
                    {% endif %}
                    
                    <!-- æ‰‹åŠ¨æ¸²æŸ“æ¯ä¸ªå­—æ®µä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤º -->
                    <div class="form-group">
                        <label class="control-label">{{ form.title.label }}</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                     <!-- æ–°å¢ï¼šMarkdown å¯¼å…¥åŠŸèƒ½ -->
                <div class="import-markdown-section">
                    <div class="import-header">
                        <i class="fas fa-file-import"></i>
                        <span>å¯¼å…¥ Markdown æ–‡ä»¶</span>
                    </div>
                    <div class="import-controls">
                        <input type="file" id="markdownFileInput" class="import-file-input" accept=".md,.txt,.markdown">
                        <button type="button" class="btn-import" onclick="document.getElementById('markdownFileInput').click()">
                            <i class="fas fa-folder-open"></i> é€‰æ‹© Markdown æ–‡ä»¶
                        </button>
                        <span class="file-info" id="fileInfo">æœªé€‰æ‹©æ–‡ä»¶</span>
                    </div>
                    
                    <!-- å¯¼å…¥é€‰é¡¹ -->
                    <div class="import-options" id="importOptions">
                        <div class="option-group">
                            <label>
                                <input type="checkbox" id="useFileName" checked>
                                ä½¿ç”¨æ–‡ä»¶åä½œä¸ºæ–‡ç« æ ‡é¢˜
                            </label>
                        </div>
                        <div class="option-group">
                            <label>
                                <input type="checkbox" id="overwriteContent">
                                è¦†ç›–å½“å‰å†…å®¹ï¼ˆä¸å‹¾é€‰åˆ™è¿½åŠ åˆ°æœ«å°¾ï¼‰
                            </label>
                        </div>
                        <div class="option-group">
                            <button type="button" class="btn-import" id="confirmImport">
                                <i class="fas fa-check"></i> ç¡®è®¤å¯¼å…¥
                            </button>
                            <button type="button" class="btn btn-cancel" id="cancelImport" style="margin-left: 10px;">
                                <i class="fas fa-times"></i> å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ–‡ä»¶é¢„è§ˆ -->
                    <div class="import-preview" id="importPreview">
                        <div class="preview-title">æ–‡ä»¶é¢„è§ˆ</div>
                        <div class="preview-content" id="previewContent"></div>
                        <div class="preview-actions">
                            <button type="button" class="btn-preview-toggle" id="togglePreview">
                                å±•å¼€é¢„è§ˆ
                            </button>
                        </div>
                    </div>
                </div>
                    <!-- æ ‡ç­¾å­—æ®µ -->
                    <div class="form-group">
                        <label class="control-label">{{ form.tag.label }}</label>
                        {{ form.tag }}
                        {% if form.tag.errors %}
                            <div class="text-danger">{{ form.tag.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- å†…å®¹å­—æ®µ - è¿™æ˜¯æœ€é‡è¦çš„ -->
                    <div class="form-group">
                        <label class="control-label">{{ form.content.label }}</label>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <div class="text-danger">{{ form.content.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="control-label">{{ form.is_top.label }}</label>
                        {{ form.is_top }}
                        {% if form.is_top.errors %}
                            <div class="text-danger">{{ form.is_top.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="control-label">{{ form.cover_img.label }}</label>
                        
                        <!-- ç¼–è¾‘æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºå½“å‰å›¾ç‰‡å’Œæ›´æ¢é€‰é¡¹ -->
                        {% if form.instance.id and form.instance.cover_img %}
                        <div class="current-cover" style="margin-bottom: 15px;">
                            <p style="font-size: 12px; color: #333; margin-top: 5px;">
                                å¦‚éœ€æ›´æ¢å°é¢ï¼Œè¯·é€‰æ‹©æ–°å›¾ç‰‡
                            </p>
                        </div>
                        {% endif %}
                        
                        <!-- æ›¿æ¢é»˜è®¤çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                        <div class="file-input-wrapper">
                            <input type="file" name="cover_img" class="form-control" id="id_cover_img_custom" 
                                accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-upload" onclick="document.getElementById('id_cover_img_custom').click()">
                                <i class="fa fa-upload"></i> é€‰æ‹©å°é¢å›¾ç‰‡
                            </button>
                            <span class="file-name" style="margin-left: 10px; color: #333;">æœªé€‰æ‹©æ–‡ä»¶</span>
                        </div>
                        
                        <!-- éšè—åŸæœ‰çš„cover_imgå­—æ®µ -->
                        {{ form.cover_img.as_hidden }}
                        
                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                        <div class="cover-preview-container">
                            <img id="coverPreview" class="cover-preview" style="display: none;">
                        </div>
                        
                        {% if form.cover_img.errors %}
                            <div class="text-danger">{{ form.cover_img.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- æ·»åŠ æäº¤æŒ‰é’®åŒºåŸŸ -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-submit">
                            <i class="fa fa-paper-plane"></i> 
                            {% if form.instance.id %}ä¿å­˜ä¿®æ”¹{% else %}å‘å¸ƒæ–‡ç« {% endif %}
                        </button>
                        <button type="button" class="btn btn-cancel" onclick="window.history.back()">
                            <i class="fa fa-times"></i> å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script>
    // è·å– CSRF token çš„å‡½æ•°
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formControls = document.querySelectorAll('input, select, textarea');
        formControls.forEach(control => {
            control.classList.add('form-control');
        });

        // å­˜å‚¨ CodeMirror å®ä¾‹
        let codeMirrorInstance = null;

        // ç­‰å¾… CodeMirror åˆå§‹åŒ–å®Œæˆåè·å–å®ä¾‹
        function waitForCodeMirror() {
            const checkCodeMirror = setInterval(() => {
                // æŸ¥æ‰¾ CodeMirror ç¼–è¾‘å™¨
                const codeMirrorElement = document.querySelector('.CodeMirror');
                if (codeMirrorElement && codeMirrorElement.CodeMirror) {
                    codeMirrorInstance = codeMirrorElement.CodeMirror;
                    console.log('è·å–åˆ° CodeMirror å®ä¾‹:', codeMirrorInstance);
                    clearInterval(checkCodeMirror);
                    return;
                }
                
                // é€šè¿‡ç¼–è¾‘å™¨å®¹å™¨æŸ¥æ‰¾
                const editorContainer = document.querySelector('.editormd');
                if (editorContainer && editorContainer.editor && editorContainer.editor.cm) {
                    codeMirrorInstance = editorContainer.editor.cm;
                    console.log('é€šè¿‡ç¼–è¾‘å™¨å®¹å™¨è·å– CodeMirror å®ä¾‹');
                    clearInterval(checkCodeMirror);
                    return;
                }
            }, 100);
            
            // 5ç§’ååœæ­¢æ£€æŸ¥
            setTimeout(() => {
                clearInterval(checkCodeMirror);
                if (!codeMirrorInstance) {
                    console.log('æœªæ‰¾åˆ° CodeMirror å®ä¾‹ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                }
            }, 5000);
        }

        // å¼€å§‹ç­‰å¾… CodeMirror
        waitForCodeMirror();

        // å­—ç¬¦è®¡æ•°åŠŸèƒ½
        function initCharCount() {
            const titleInput = document.querySelector('input[name="title"]');
            const contentTextarea = document.querySelector('textarea[name="content"]');

            if (titleInput) {
                const titleCounter = document.createElement('div');
                titleCounter.className = 'char-count';
                titleCounter.innerHTML = `${titleInput.value.length}/100`;
                titleInput.parentNode.appendChild(titleCounter);

                titleInput.addEventListener('input', function() {
                    const count = this.value.length;
                    titleCounter.innerHTML = `${count}/100`;
                    if (count > 100) {
                        titleCounter.style.color = '#dc3545';
                    } else {
                        titleCounter.style.color = '#6c757d';
                    }
                });
            }

            if (contentTextarea) {
                const contentCounter = document.createElement('div');
                contentCounter.className = 'char-count';
                contentCounter.innerHTML = `${contentTextarea.value.length}/5000`;
                contentTextarea.parentNode.appendChild(contentCounter);

                contentTextarea.addEventListener('input', function() {
                    const count = this.value.length;
                    contentCounter.innerHTML = `${count}/5000`;
                    if (count > 5000) {
                        contentCounter.style.color = '#dc3545';
                    } else {
                        contentCounter.style.color = '#6c757d';
                    }
                });
            }
        }

        // å°é¢å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
        function initCoverPreview() {
            const customFileInput = document.getElementById('id_cover_img_custom');
            const originalFileInput = document.querySelector('input[name="cover_img"]');
            const fileNameSpan = document.querySelector('.file-name');
            const previewImg = document.getElementById('coverPreview');

            if (customFileInput) {
                customFileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        // éªŒè¯æ–‡ä»¶ç±»å‹
                        if (!file.type.match('image.*')) {
                            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                            this.value = '';
                            previewImg.style.display = 'none';
                            fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                            return;
                        }

                        // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
                        if (file.size > 5 * 1024 * 1024) {
                            alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼');
                            this.value = '';
                            previewImg.style.display = 'none';
                            fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                            return;
                        }

                        // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
                        fileNameSpan.textContent = file.name;
                        
                        // æ˜¾ç¤ºé¢„è§ˆ
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                        
                        // åˆ›å»ºFileListå¹¶è®¾ç½®åˆ°åŸå§‹input
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        originalFileInput.files = dt.files;
                    } else {
                        previewImg.style.display = 'none';
                        fileNameSpan.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                    }
                });
            }
            
            // ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºå½“å‰å°é¢
            {% if form.instance.cover_img %}
            if (previewImg) {
                previewImg.src = "{{ form.instance.cover_img.url }}";
                previewImg.style.display = 'block';
                fileNameSpan.textContent = 'å½“å‰å°é¢: {{ form.instance.cover_img.name }}';
            }
            {% endif %}
        }

        // è¡¨å•æäº¤å¤„ç†
        function enhanceFormSubmit() {
            const form = document.getElementById('articleForm');
            const submitBtn = form.querySelector('.btn-submit');
            const isEditMode = document.querySelector('input[name="edit_mode"]');

            form.addEventListener('submit', function (e) {
                const title = document.querySelector('input[name="title"]')?.value.trim();
                const content = document.querySelector('textarea[name="content"]')?.value.trim();

                if (!title) {
                    e.preventDefault();
                    showMessage('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜', 'error');
                    document.querySelector('input[name="title"]').focus();
                    return false;
                }

                if (!content) {
                    e.preventDefault();
                    showMessage('è¯·è¾“å…¥æ–‡ç« å†…å®¹', 'error');
                    document.querySelector('textarea[name="content"]').focus();
                    return false;
                }

                // æ·»åŠ æäº¤åŠ¨ç”»
                const buttonText = isEditMode ? 'ä¿å­˜ä¸­...' : 'å‘å¸ƒä¸­...';
                submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${buttonText}`;
                submitBtn.disabled = true;
                
                return true;
            });
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;

            const colors = {
                error: '#dc3545',
                success: '#28a745',
                info: '#17a2b8',
                warning: '#ffc107'
            };

            messageDiv.style.backgroundColor = colors[type] || colors.info;
            messageDiv.textContent = message;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }

        // ä¸“é—¨é’ˆå¯¹ CodeMirror çš„ç¼–è¾‘å™¨å†…å®¹æ›´æ–°å‡½æ•°
        function updateEditorContent(newContent, overwrite) {
            console.log('=== å¼€å§‹æ›´æ–°ç¼–è¾‘å™¨å†…å®¹ (CodeMirror æ–¹æ¡ˆ) ===');
            let finalContent = newContent;
            
            // æ–¹æ³•1ï¼šç›´æ¥æ“ä½œ CodeMirror å®ä¾‹
            function updateCodeMirrorDirectly() {
                console.log('å°è¯•ç›´æ¥æ›´æ–° CodeMirror');
                
                if (codeMirrorInstance && typeof codeMirrorInstance.setValue === 'function') {
                    try {
                        // è·å–å½“å‰å†…å®¹
                        const currentContent = codeMirrorInstance.getValue() || '';
                        console.log('å½“å‰ CodeMirror å†…å®¹é•¿åº¦:', currentContent.length);
                        
                        // å¤„ç†è¦†ç›–/è¿½åŠ é€»è¾‘
                        if (!overwrite && currentContent.trim()) {
                            finalContent = currentContent + '\n\n' + newContent;
                        }
                        
                        console.log('è®¾ç½® CodeMirror å†…å®¹é•¿åº¦:', finalContent.length);
                        
                        // è®¾ç½®å†…å®¹åˆ° CodeMirror
                        codeMirrorInstance.setValue(finalContent);
                        
                        // åˆ·æ–°ç¼–è¾‘å™¨
                        codeMirrorInstance.refresh();
                        
                        // è§¦å‘å˜åŒ–äº‹ä»¶
                        codeMirrorInstance.triggerOnChange();
                        
                        console.log('CodeMirror ç›´æ¥æ›´æ–°æˆåŠŸ');
                        return true;
                    } catch (e) {
                        console.log('CodeMirror ç›´æ¥æ›´æ–°å¤±è´¥:', e);
                    }
                }
                return false;
            }
            
            // æ–¹æ³•2ï¼šé€šè¿‡ç¼–è¾‘å™¨å®¹å™¨æ›´æ–°
            function updateViaEditorContainer() {
                console.log('å°è¯•é€šè¿‡ç¼–è¾‘å™¨å®¹å™¨æ›´æ–°');
                
                const editorContainer = document.querySelector('.editormd');
                if (editorContainer && editorContainer.editor) {
                    try {
                        const editor = editorContainer.editor;
                        const currentContent = editor.getValue() || '';
                        
                        if (!overwrite && currentContent.trim()) {
                            finalContent = currentContent + '\n\n' + newContent;
                        }
                        
                        editor.setValue(finalContent);
                        editor.isChanged = true;
                        
                        // åˆ·æ–° CodeMirror
                        if (editor.cm) {
                            editor.cm.refresh();
                        }
                        
                        console.log('é€šè¿‡ç¼–è¾‘å™¨å®¹å™¨æ›´æ–°æˆåŠŸ');
                        return true;
                    } catch (e) {
                        console.log('é€šè¿‡ç¼–è¾‘å™¨å®¹å™¨æ›´æ–°å¤±è´¥:', e);
                    }
                }
                return false;
            }
            
            // æ–¹æ³•3ï¼šåŒæ—¶æ›´æ–°éšè—çš„ textarea å’Œ CodeMirror
            function updateBothTextareaAndCodeMirror() {
                console.log('å°è¯•åŒæ—¶æ›´æ–° textarea å’Œ CodeMirror');
                
                let success = false;
                
                // æ›´æ–°éšè—çš„ textarea
                const textareaSelectors = [
                    'textarea[name="content"]',
                    '.editormd-markdown-textarea',
                    '.editormd-textarea'
                ];
                
                let targetTextarea = null;
                for (const selector of textareaSelectors) {
                    targetTextarea = document.querySelector(selector);
                    if (targetTextarea) {
                        console.log('æ‰¾åˆ°éšè— textarea:', selector);
                        break;
                    }
                }
                
                if (targetTextarea) {
                    const currentContent = targetTextarea.value || '';
                    if (!overwrite && currentContent.trim()) {
                        finalContent = currentContent + '\n\n' + newContent;
                    }
                    
                    targetTextarea.value = finalContent;
                    triggerAllTextareaEvents(targetTextarea);
                    success = true;
                    console.log('éšè— textarea æ›´æ–°æˆåŠŸ');
                }
                
                // åŒæ—¶æ›´æ–° CodeMirror
                if (codeMirrorInstance && typeof codeMirrorInstance.setValue === 'function') {
                    try {
                        codeMirrorInstance.setValue(finalContent);
                        codeMirrorInstance.refresh();
                        success = true;
                        console.log('CodeMirror åŒæ­¥æ›´æ–°æˆåŠŸ');
                    } catch (e) {
                        console.log('CodeMirror åŒæ­¥æ›´æ–°å¤±è´¥:', e);
                    }
                }
                
                return success;
            }
            
            // æ–¹æ³•4ï¼šæ¨¡æ‹Ÿé”®ç›˜è¾“å…¥åˆ° CodeMirror
            function simulateCodeMirrorInput() {
                console.log('å°è¯•æ¨¡æ‹Ÿé”®ç›˜è¾“å…¥åˆ° CodeMirror');
                
                if (!codeMirrorInstance) {
                    return false;
                }
                
                try {
                    // èšç„¦åˆ° CodeMirror
                    codeMirrorInstance.focus();
                    
                    // å…¨é€‰ç°æœ‰å†…å®¹
                    codeMirrorInstance.execCommand('selectAll');
                    
                    // æ›¿æ¢é€‰ä¸­å†…å®¹
                    codeMirrorInstance.replaceSelection(finalContent);
                    
                    // åˆ·æ–°æ˜¾ç¤º
                    codeMirrorInstance.refresh();
                    
                    console.log('CodeMirror æ¨¡æ‹Ÿè¾“å…¥æˆåŠŸ');
                    return true;
                } catch (e) {
                    console.log('CodeMirror æ¨¡æ‹Ÿè¾“å…¥å¤±è´¥:', e);
                    return false;
                }
            }
            
            // æ‰§è¡Œæ›´æ–°ç­–ç•¥
            console.log('æ‰§è¡Œ CodeMirror æ›´æ–°ç­–ç•¥...');
            
            // ç­–ç•¥1ï¼šç›´æ¥æ›´æ–° CodeMirror
            if (updateCodeMirrorDirectly()) {
                console.log('CodeMirror ç›´æ¥æ›´æ–°æˆåŠŸ');
                updateCharCount(finalContent.length);
                showMessage('Markdown å†…å®¹å¯¼å…¥æˆåŠŸï¼', 'success');
                return;
            }
            
            // ç­–ç•¥2ï¼šé€šè¿‡ç¼–è¾‘å™¨å®¹å™¨æ›´æ–°
            if (updateViaEditorContainer()) {
                console.log('ç¼–è¾‘å™¨å®¹å™¨æ›´æ–°æˆåŠŸ');
                updateCharCount(finalContent.length);
                showMessage('Markdown å†…å®¹å¯¼å…¥æˆåŠŸï¼', 'success');
                return;
            }
            
            // ç­–ç•¥3ï¼šåŒæ—¶æ›´æ–°ä¸¤è€…
            if (updateBothTextareaAndCodeMirror()) {
                console.log('åŒæ—¶æ›´æ–°æˆåŠŸ');
                updateCharCount(finalContent.length);
                showMessage('Markdown å†…å®¹å¯¼å…¥æˆåŠŸï¼', 'success');
                return;
            }
            
            // ç­–ç•¥4ï¼šæ¨¡æ‹Ÿè¾“å…¥
            if (simulateCodeMirrorInput()) {
                console.log('æ¨¡æ‹Ÿè¾“å…¥æˆåŠŸ');
                updateCharCount(finalContent.length);
                showMessage('Markdown å†…å®¹å¯¼å…¥æˆåŠŸï¼', 'success');
                return;
            }
            
            // æœ€ç»ˆåå¤‡æ–¹æ¡ˆ
            console.log('æ‰€æœ‰ CodeMirror æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨å‰ªè´´æ¿æ–¹æ¡ˆ');
            useEnhancedClipboard(finalContent);
        }

        // å¢å¼ºçš„äº‹ä»¶è§¦å‘å‡½æ•°
        function triggerAllTextareaEvents(textarea) {
            if (!textarea) return;
            
            console.log('è§¦å‘ textarea äº‹ä»¶');
            
            // åŸç”Ÿäº‹ä»¶
            const events = ['input', 'change', 'keyup', 'keydown', 'blur', 'focus'];
            events.forEach(eventType => {
                try {
                    const event = new Event(eventType, { bubbles: true, cancelable: true });
                    textarea.dispatchEvent(event);
                } catch (e) {
                    console.log(`äº‹ä»¶ ${eventType} è§¦å‘å¤±è´¥:`, e);
                }
            });
            
            // jQuery äº‹ä»¶
            if (window.jQuery && typeof jQuery === 'function') {
                try {
                    const $textarea = jQuery(textarea);
                    $textarea.trigger('input');
                    $textarea.trigger('change');
                    $textarea.trigger('keyup');
                    console.log('jQuery äº‹ä»¶è§¦å‘æˆåŠŸ');
                } catch (e) {
                    console.log('jQuery äº‹ä»¶è§¦å‘å¤±è´¥:', e);
                }
            }
        }

        // å¢å¼ºçš„å‰ªè´´æ¿æ–¹æ¡ˆ
        function useEnhancedClipboard(content) {
            console.log('ä½¿ç”¨å¢å¼ºå‰ªè´´æ¿æ–¹æ¡ˆ');
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 90%;
                max-height: 90%;
                width: 600px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                display: flex;
                flex-direction: column;
            `;
            
            modalContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“‹</div>
                    <h2 style="margin: 0 0 10px 0; color: #333;">å†…å®¹å·²å‡†å¤‡å¥½</h2>
                    <p style="color: #666; margin: 0;">è¯·å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°ç¼–è¾‘å™¨ä¸­</p>
                </div>
                
                <div style="flex: 1; margin-bottom: 20px; position: relative;">
                    <textarea 
                        id="importedContent" 
                        style="
                            width: 100%;
                            height: 300px;
                            padding: 15px;
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            font-family: 'Monaco', 'Menlo', monospace;
                            font-size: 14px;
                            line-height: 1.5;
                            resize: vertical;
                            background: #f8f9fa;
                        "
                        readonly
                    >${content}</textarea>
                    <button 
                        onclick="copyImportedContent()"
                        style="
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: #667eea;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 12px;
                        "
                    >ğŸ“‹ å¤åˆ¶</button>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">æ“ä½œè¯´æ˜ï¼š</h4>
                    <ol style="margin: 0; padding-left: 20px; color: #666;">
                        <li>ç‚¹å‡»ä¸Šæ–¹çš„"å¤åˆ¶"æŒ‰é’®ï¼Œæˆ–æŒ‰ Ctrl+A å…¨é€‰å†…å®¹</li>
                        <li>æŒ‰ Ctrl+C å¤åˆ¶å†…å®¹</li>
                        <li>ç‚¹å‡»ç¼–è¾‘å™¨åŒºåŸŸï¼ŒæŒ‰ Ctrl+V ç²˜è´´</li>
                    </ol>
                </div>
                
                <button 
                    onclick="this.closest('[style]').remove()"
                    style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                    "
                >å…³é—­</button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // è‡ªåŠ¨é€‰ä¸­å†…å®¹
            setTimeout(() => {
                const textarea = modalContent.querySelector('#importedContent');
                if (textarea) {
                    textarea.select();
                    textarea.focus();
                }
            }, 100);
            
            // æ·»åŠ å¤åˆ¶å‡½æ•°åˆ°å…¨å±€
            window.copyImportedContent = function() {
                const textarea = document.getElementById('importedContent');
                if (textarea) {
                    textarea.select();
                    try {
                        const successful = document.execCommand('copy');
                        if (successful) {
                            showMessage('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                        } else {
                            showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å†…å®¹', 'warning');
                        }
                    } catch (err) {
                        showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å†…å®¹', 'warning');
                    }
                }
            };
            
            showMessage('å†…å®¹å·²å‡†å¤‡å¥½ï¼Œè¯·å¤åˆ¶å¼¹å‡ºæ¡†ä¸­çš„å†…å®¹', 'info');
        }

        // å­—ç¬¦è®¡æ•°æ›´æ–°å‡½æ•°
        function updateCharCount(length) {
            const contentCounter = document.querySelector('.char-count');
            if (contentCounter) {
                contentCounter.innerHTML = `${length}/5000`;
                if (length > 5000) {
                    contentCounter.style.color = '#dc3545';
                } else {
                    contentCounter.style.color = '#6c757d';
                }
            }
        }

        // Markdown å¯¼å…¥åŠŸèƒ½
        function initMarkdownImport() {
            const fileInput = document.getElementById('markdownFileInput');
            const fileInfo = document.getElementById('fileInfo');
            const importOptions = document.getElementById('importOptions');
            const importPreview = document.getElementById('importPreview');
            const previewContent = document.getElementById('previewContent');
            const togglePreview = document.getElementById('togglePreview');
            const confirmImport = document.getElementById('confirmImport');
            const cancelImport = document.getElementById('cancelImport');
            const useFileName = document.getElementById('useFileName');
            const overwriteContent = document.getElementById('overwriteContent');
            
            let currentFile = null;
            let currentFileContent = '';
            let currentFileName = '';

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    if (!file.name.match(/\.(md|txt|markdown)$/i)) {
                        showMessage('è¯·é€‰æ‹© Markdown æ–‡ä»¶ (.md, .txt, .markdown)', 'error');
                        this.value = '';
                        return;
                    }

                    // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§2MBï¼‰
                    if (file.size > 2 * 1024 * 1024) {
                        showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB', 'error');
                        this.value = '';
                        return;
                    }

                    currentFile = file;
                    currentFileName = file.name.replace(/\.[^/.]+$/, "");
                    fileInfo.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(1)}KB)`;

                    // è¯»å–æ–‡ä»¶å†…å®¹ç”¨äºé¢„è§ˆ
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentFileContent = e.target.result;
                        
                        // æ˜¾ç¤ºé¢„è§ˆ
                        const previewText = currentFileContent.length > 500 
                            ? currentFileContent.substring(0, 500) + '...' 
                            : currentFileContent;
                        previewContent.textContent = previewText;
                        previewContent.classList.remove('expanded');
                        togglePreview.textContent = 'å±•å¼€é¢„è§ˆ';
                        
                        importPreview.classList.add('show');
                        importOptions.classList.add('show');
                    };
                    reader.onerror = function() {
                        showMessage('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                    };
                    reader.readAsText(file, 'UTF-8');
                } else {
                    resetImport();
                }
            });

            // åˆ‡æ¢é¢„è§ˆå±•å¼€/æ”¶èµ·
            togglePreview.addEventListener('click', function() {
                const isExpanded = previewContent.classList.contains('expanded');
                if (isExpanded) {
                    previewContent.textContent = currentFileContent.length > 500 
                        ? currentFileContent.substring(0, 500) + '...' 
                        : currentFileContent;
                    previewContent.classList.remove('expanded');
                    this.textContent = 'å±•å¼€é¢„è§ˆ';
                } else {
                    previewContent.textContent = currentFileContent;
                    previewContent.classList.add('expanded');
                    this.textContent = 'æ”¶èµ·é¢„è§ˆ';
                }
            });

          confirmImport.addEventListener('click', function() {
                if (!currentFile) {
                    showMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const originalText = confirmImport.innerHTML;
                confirmImport.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¯¼å…¥ä¸­...';
                confirmImport.disabled = true;

                // åˆ›å»º FormData å¯¹è±¡
                const formData = new FormData();
                formData.append('markdown_file', currentFile);
                formData.append('use_filename', useFileName.checked);
                formData.append('overwrite_content', overwriteContent.checked);
                formData.append('import_markdown', 'true');

                // è·å– CSRF token
                const csrfToken = getCSRFToken();

                // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯
                fetch('', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // æ›´æ–°æ ‡é¢˜
                        if (useFileName.checked && data.title) {
                            const titleInput = document.querySelector('input[name="title"]');
                            if (titleInput) {
                                titleInput.value = data.title;
                                const event = new Event('input', { bubbles: true });
                                titleInput.dispatchEvent(event);
                            }
                        }

                        // æ›´æ–°å†…å®¹
                        updateEditorContent(data.content, overwriteContent.checked);
                        
                        // æ˜¾ç¤ºåŒ…å«å›¾ç‰‡å¤„ç†ç»“æœçš„æ¶ˆæ¯
                        let message = 'Markdown å†…å®¹å¯¼å…¥æˆåŠŸï¼';
                        if (data.image_count > 0) {
                            message += ` å·²è‡ªåŠ¨ä¸Šä¼  ${data.image_count} å¼ å›¾ç‰‡ã€‚`;
                        } else {
                            message += ' æœªå‘ç°å¯ä¸Šä¼ çš„æœ¬åœ°å›¾ç‰‡ã€‚';
                        }
                        showMessage(message, 'success');
                        
                        resetImport();
                    } else {
                        showMessage(data.message || 'å¯¼å…¥å¤±è´¥', 'error');
                    }
                })
                .catch(error => {
                    console.error('å¯¼å…¥é”™è¯¯:', error);
                    showMessage('å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message, 'error');
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    confirmImport.innerHTML = originalText;
                    confirmImport.disabled = false;
                });
            });         
          // å–æ¶ˆå¯¼å…¥
            cancelImport.addEventListener('click', resetImport);

            function resetImport() {
                fileInput.value = '';
                fileInfo.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                importOptions.classList.remove('show');
                importPreview.classList.remove('show');
                currentFile = null;
                currentFileContent = '';
                currentFileName = '';
            }
        }

        // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
        initCharCount();
        initCoverPreview();
        enhanceFormSubmit();
        initMarkdownImport();

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}