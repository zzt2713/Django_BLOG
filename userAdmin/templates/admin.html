{% extends 'muban.html' %}
{% load static %}

{% block css %}
<title>åå°ç®¡ç†</title>
<style>
/* åœ¨ç°æœ‰çš„ CSS ä¸­æ·»åŠ  */
.card {
    margin-bottom: 20px;
}

.card-body h5 {
    color: #333;
    margin-bottom: 15px;
    border-bottom: 2px solid #667eea;
    padding-bottom: 8px;
}

.card-body p {
    margin-bottom: 10px;
    line-height: 1.6;
}

.card-body strong {
    color: #555;
    min-width: 100px;
    display: inline-block;
}
    body {
        background: url('{% static 'img/bg.png' %}') no-repeat center center fixed;
        background-size: 100% 100%;
        margin: 0;
        padding: 0;
    }
    .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.search-box {
    display: flex;
}

.search-box form {
    display: flex;
    gap: 10px;
}

.search-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    width: 300px;
    outline: none;
    transition: border-color 0.3s;
}

.search-input:focus {
    border-color: #3498db;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
}

.search-btn {
    padding: 8px 16px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
}

.search-btn:hover {
    background-color: #2980b9;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        align-items: stretch;
    }

    .search-box form {
        flex-direction: column;
    }

    .search-input {
        width: 100%;
    }
}
    .card-img-container {
    height: 200px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
}

.card-img-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
    .card-title{
        font-size: 18px !important;
        font-weight: bold;
    }
    .card-text{
        font-size: 15px !important;
    }
    .admin-container {
        margin-top: 80px;
        padding: 20px;
    }

    .admin-sidebar {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        height: fit-content;
    }

    .admin-content {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        min-height: 800px;
    }

    .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar-menu li {
        margin-bottom: 10px;
    }

    .sidebar-menu a {
        display: block;
        padding: 12px 15px;
        color: #333;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
        background: linear-gradient(135deg, #de0606 0%, #764ba2 100%);
        color: white;
        transform: translateX(5px);
    }

    .admin-header {
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 25px;
    }

    .admin-header h2 {
        color: #333;
        margin: 0;
        font-weight: bold;
    }

    .data-table {
        width: 100%;
        background: rgba(255,255,255, 0.5);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .data-table th {
        background: linear-gradient(135deg, #4a9ffa 0%, #4a9ffa 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
    }

    .data-table tr:hover {
        background-color: #f8f9fa;
    }

    .btn-action {
        padding: 6px 12px;
        margin: 2px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .btn-edit {
        background: #28a745;
        color: white;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-add {
        background: linear-gradient(135deg, #667eea 0%, #1e44ed 100%);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        margin-bottom: 20px;
        float: right;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
    }

    .form-control {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .pagination {
        margin-top: 20px;
        justify-content: center;
    }

    .empty-state {
        text-align: center;
        padding: 50px;
        color: #666;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #ddd;
    }

    /* ä¼˜åŒ–æ•°æ®æ¦‚è§ˆæ ·å¼ */
    .row .col-md-3 {
        margin-bottom: 20px;
    }

    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
    }

    .card-body {
        padding: 25px;
        text-align: center;
        position: relative;
    }

    .card-body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card.bg-primary .card-body::before {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card.bg-success .card-body::before {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .card.bg-warning .card-body::before {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .card.bg-info .card-body::before {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .card.bg-tag .card-body::before {
        background: linear-gradient(135deg, #4f00f9 0%, #b07af3 100%);
    }

    .card-body h4 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .card-body p {
        font-size: 1rem;
        margin: 0;
        opacity: 0.9;
        font-weight: 500;
    }

    .bg-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .bg-success {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
    }

    .bg-warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important;
    }

    .bg-info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
    }
    .bg-tag {
        background: linear-gradient(135deg, #7003aa 0%, #dbd0f3 100%) !important;
    }
</style>
{% endblock %}

{% block content %}
    <div class="admin-container">
        <div class="container-fluid">
            <div class="row">
                <!-- å·¦ä¾§èœå• -->
                <div class="col-md-3">
                    <div class="admin-sidebar">
                        <h4 style="color: #333; margin-bottom: 20px; text-align: center;">
                            <i class="fa fa-cog"></i> ç®¡ç†èœå•
                        </h4>
                        <ul class="sidebar-menu">
                            <li><a href="{% url 'admin_user' %}" class="{% if current_section == 'dashboard' %}active{% endif %}">
                                <i class="fa fa-tachometer"></i> æ•°æ®æ¦‚è§ˆ
                            </a></li>
                            <li><a href="{% url 'admin_content' %}" class="{% if current_section == 'content' %}active{% endif %}">
                                <i class="fa fa-file-text"></i> æ–‡ç« ç®¡ç†
                            </a></li>
                            <li><a href="{% url 'admin_user_manage' %}" class="{% if current_section == 'users' %}active{% endif %}">
                                <i class="fa fa-users"></i> ç”¨æˆ·ç®¡ç†
                            </a></li>
                            <li><a href="{% url 'admin_comments' %}" class="{% if current_section == 'comments' %}active{% endif %}">
                                <i class="fa fa-comments"></i> ç•™è¨€ç®¡ç†
                            </a></li>
                            <li><a href="{% url 'admin_pictures' %}" class="{% if current_section == 'pictures' %}active{% endif %}">
                                <i class="fa fa-picture-o"></i> ç›¸å†Œç®¡ç†
                            </a></li>
                            <li><a href="{% url 'admin_leavemeg' %}" class="{% if current_section == 'leavemeg' %}active{% endif %}">
                                <i class="fa fa-commenting"></i> å¼¹å¹•ç®¡ç†
                            </a></li>
                            <li><a href="{% url 'admin_tags' %}" class="{% if current_section == 'tags' %}active{% endif %}">
                                <i class="fa fa-tags"></i> æ ‡ç­¾ç®¡ç†
                            </a></li>
                            <li><a href="{% url 'admin_announcements' %}" class="{% if current_section == 'announcements' %}active{% endif %}">
                                <i class="fa fa-bullhorn"></i> å…¬å‘Šç®¡ç†
                            </a></li>
                            <li><a href="{% url 'admin_siteinfo' %}" class="{% if current_section == 'siteinfo' %}active{% endif %}">
                                <i class="fa fa-info-circle"></i> ç½‘ç«™ä¿¡æ¯
                            </a></li>
                        </ul>
                    </div>
                </div>

                <!-- å³ä¾§å†…å®¹ -->
                <div class="col-md-9">
                    <div class="admin-content">
                        {% if current_section == 'dashboard' %}
                            <!-- ä»ªè¡¨ç›˜ -->
                            <div class="admin-header">
                                <h2><i class="fa fa-tachometer"></i> æ•°æ®æ¦‚è§ˆ</h2>
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card text-white bg-primary mb-3">
                                        <div class="card-body">
                                            <h4>{{ user_count }}</h4>
                                            <p>ç”¨æˆ·æ€»æ•°</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-success mb-3">
                                        <div class="card-body">
                                            <h4>{{ content_count }}</h4>
                                            <p>æ–‡ç« æ€»æ•°</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-warning mb-3">
                                        <div class="card-body">
                                            <h4>{{ comment_count }}</h4>
                                            <p>ç•™è¨€æ€»æ•°</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-info mb-3">
                                        <div class="card-body">
                                            <h4>{{ picture_count }}</h4>
                                            <p>å›¾ç‰‡æ€»æ•°</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-tag mb-3">
                                        <div class="card-body">
                                            <h4>{{ tag_count }}</h4>
                                            <p>æ ‡ç­¾æ€»æ•°</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        {% elif current_section == 'content' %}
                            <!-- æ–‡ç« ç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-file-text"></i> æ–‡ç« ç®¡ç†</h2>
                                <a class="btn-add" href="/content/add/" style="text-decoration: none;color: white;">
                                    <i class="fa fa-plus"></i> æ·»åŠ æ–‡ç« 
                                </a>
                            </div>
                            {% if contents %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>æ–‡ç« å°é¢</th>
                                        <th>æ ‡é¢˜</th>
                                        <th>æ ‡ç­¾</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>ç‚¹èµæ•°</th>
                                        <th>æµè§ˆé‡</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for content in contents %}
                                    <tr>
                                        <td>{{ content.id }}</td>
                                        <td><img src="/media/{{ content.cover_img }}" style="width: 300px; height:150px;"></td>
                                        <td>{{ content.title }}</td>
                                        <td>{{ content.tag }}</td>
                                        <td>{{ content.date|date:"Y-m-d H:i" }}</td>
                                        <td>{{ content.like_count }}</td>
                                        <td>{{ content.look_count }}</td>
                                        <td>
                                            <a class="btn-action btn-edit" href="/content/article/edit/?nid={{content.id}}" >
                                                <i class="fa fa-edit"></i> ç¼–è¾‘
                                            </a>
                                            <button class="btn-action btn-delete" onclick="deleteContent({{ content.id }})">
                                                <i class="fa fa-trash"></i> åˆ é™¤
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                                <ul class="pagination">
                                    {{ page_string }}
                                </ul>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-file-text"></i>
                                <h4>æš‚æ— æ–‡ç« </h4>
                                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ç¯‡æ–‡ç« </p>
                            </div>
                            {% endif %}

                         {% elif current_section == 'users' %}
                            <!-- ç”¨æˆ·ç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-users"></i> ç”¨æˆ·ç®¡ç†</h2>
                                <!-- æœç´¢æ¡† -->
                                <div class="search-box">
                                    <form method="get" action="">
                                        <input type="hidden" name="section" value="users">
                                        <input type="text" name="search" placeholder="æœç´¢ç”¨æˆ·å..." value="{{ search_query|default:'' }}"
                                               class="search-input">
                                        <button type="submit" class="search-btn">
                                            <i class="fa fa-search"></i> æœç´¢
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% if users %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ç”¨æˆ·å¤´åƒ</th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>é‚®ç®±</th>
                                        <th>èº«ä»½</th>
                                        <th>æ³¨å†Œæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td>
                                            {% if user.avatar %}
                                            <img src="{{ user.avatar.url }}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
                                            {% else %}
                                            ç”¨æˆ·æœªè®¾ç½®å¤´åƒ
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ user.username }}
                                        </td>
                                         <td>
                                            {% if user.email %}
                                            {{ user.email }}
                                            {% else %}
                                            æµ‹è¯•è´¦å·ï¼Œæœªå¡«å†™é‚®ç®±
                                            {% endif %}
                                        </td>
                                        <td>{{ user.get_role_display }}</td>
                                        <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            <button class="btn-action btn-edit" onclick="editUser({{ user.id }})">
                                                <i class="fa fa-edit"></i> é‡ç½®å¯†ç 
                                            </button>
                                            {% if user.role != 1 %}
                                            <button class="btn-action btn-delete" onclick="deleteUser({{ user.id }})">
                                                <i class="fa fa-trash"></i> åˆ é™¤
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <ul class="pagination">
                                {{ page_string }}
                            </ul>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-users"></i>
                                <h4>æš‚æ— ç”¨æˆ·</h4>
                            </div>
                            {% endif %}

                        {% elif current_section == 'comments' %}
                            <!-- ç•™è¨€ç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-comments"></i> ç•™è¨€ç®¡ç†</h2>
                            </div>

                            {% if comments %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ç”¨æˆ·</th>
                                        <th>ç•™è¨€å†…å®¹</th>
                                        <th>ç•™è¨€æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for comment in comments %}
                                    <tr>
                                        <td>{{ comment.user_id.username }}</td>
                                        <td>{{ comment.content|truncatewords:10 }}</td>
                                        <td>{{ comment.date|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            <button class="btn-action btn-delete" onclick="deleteComment({{ comment.id }})">
                                                <i class="fa fa-trash"></i> åˆ é™¤
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                                <ul class="pagination">
                                    {{ page_string }}
                                </ul>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-comments"></i>
                                <h4>æš‚æ— ç•™è¨€</h4>
                            </div>
                            {% endif %}

                        {% elif current_section == 'pictures' %}
                            <!-- ç›¸å†Œç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-picture-o"></i> ç›¸å†Œç®¡ç†</h2>
                                <button class="btn-add"  data-toggle="modal" data-target="#uploadModal">
                                    <i class="fa fa-plus"></i> æ·»åŠ å›¾ç‰‡
                                </button>
                            </div>

                            {% if pictures %}
                            <div class="row">
                                {% for picture in pictures %}
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-img-container" style="height: 200px; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #f8f9fa;">
                                            <img src="/{{ picture.path }}" class="card-img-top" alt="{{ picture.title }}"
                                                style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title">{{ picture.title }}</h5>
                                            <p class="card-text">{{ picture.description|truncatewords:5 }}</p>
                                            <button class="btn-action btn-delete" onclick="deletePicture({{ picture.id }})">
                                                <i class="fa fa-trash"></i> åˆ é™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                            </div>
                                <ul class="pagination">
                                    {{ page_string }}
                                </ul>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-picture-o"></i>
                                <h4>æš‚æ— å›¾ç‰‡</h4>
                                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€å¼ å›¾ç‰‡</p>
                            </div>
                            {% endif %}


                        {% elif current_section == 'leavemeg' %}
                            <!-- å¼¹å¹•ç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-commenting"></i> å¼¹å¹•ç®¡ç†</h2>
                            </div>

                            {% if leavemegs %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>å¼¹å¹•å†…å®¹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for leavemeg in leavemegs %}
                                    <tr>
                                        <td>{{ leavemeg.id }}</td>
                                        <td>{{ leavemeg.content }}</td>
                                        <td>
                                            <button class="btn-action btn-delete" onclick="deleteLeaveMeg({{ leavemeg.id }})">
                                                <i class="fa fa-trash"></i> åˆ é™¤
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                                <ul class="pagination">
                                    {{ page_string }}
                                </ul>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-commenting"></i>
                                <h4>æš‚æ— å¼¹å¹•</h4>
                            </div>
                            {% endif %}
                        {% elif current_section == 'tags' %}
                            <!-- æ ‡ç­¾ç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-tags"></i> æ ‡ç­¾ç®¡ç†</h2>
                                <button class="btn-add" onclick="showTagForm()">
                                    <i class="fa fa-plus"></i> æ·»åŠ æ ‡ç­¾
                                </button>
                            </div>

                            {% if tags %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>æ ‡ç­¾ID</th>
                                        <th>æ ‡ç­¾åç§°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tag in tags %}
                                    <tr>
                                        <td>{{ tag.id }}</td>
                                        <td>{{ tag.tag }}</td>
                                        <td>
                                            <button class="btn-action btn-edit" onclick="editTag({{ tag.id }})">
                                                <i class="fa fa-edit"></i> ç¼–è¾‘
                                            </button>
                                            <button class="btn-action btn-delete" onclick="deleteTag({{ tag.id }})">
                                                <i class="fa fa-trash"></i> åˆ é™¤
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                                <ul class="pagination">
                                    {{ page_string }}
                                </ul>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-tags"></i>
                                <h4>æš‚æ— æ ‡ç­¾</h4>
                                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªæ ‡ç­¾</p>
                            </div>
                            {% endif %}
                        {% elif current_section == 'announcements' %}
                            <!-- å…¬å‘Šç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-bullhorn"></i> å…¬å‘Šç®¡ç†</h2>
                                <button class="btn-add" onclick="showAnnouncementForm()">
                                    <i class="fa fa-plus"></i> æ·»åŠ å…¬å‘Š
                                </button>
                            </div>

                            {% if announcements %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ç‰ˆæœ¬å·</th>
                                        <th>æ›´æ–°å†…å®¹</th>
                                        <th>æ›´æ–°æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for announcement in announcements %}
                                    <tr>
                                        <td>{{ announcement.id }}</td>
                                        <td>{{ announcement.version }}</td>
                                        <td>{{ announcement.content }}</td>
                                        <td>{{ announcement.time|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            <button class="btn-action btn-edit" onclick="editAnnouncement({{ announcement.id }})">
                                                <i class="fa fa-edit"></i> ç¼–è¾‘
                                            </button>
                                            <button class="btn-action btn-delete" onclick="deleteAnnouncement({{ announcement.id }})">
                                                <i class="fa fa-trash"></i> åˆ é™¤
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <ul class="pagination">
                                {{ page_string }}
                            </ul>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-bullhorn"></i>
                                <h4>æš‚æ— å…¬å‘Š</h4>
                                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡å…¬å‘Š</p>
                            </div>
                            {% endif %}

                            {% elif current_section == 'siteinfo' %}
                            <!-- ç½‘ç«™ä¿¡æ¯ç®¡ç† -->
                            <div class="admin-header">
                                <h2><i class="fa fa-info-circle"></i> ç½‘ç«™ä¿¡æ¯ç®¡ç†</h2>
                                <button class="btn-add" onclick="showSiteInfoForm()">
                                    <i class="fa fa-edit"></i> ç¼–è¾‘ç½‘ç«™ä¿¡æ¯
                                </button>
                            </div>

                            {% if site_info %}
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5><i class="fa fa-user"></i> ç®¡ç†å‘˜ä¿¡æ¯</h5>
                                            <p><strong>ç®¡ç†å‘˜ï¼š</strong>{{ site_info.admin.username }}</p>
                                            <p><strong>æ–‡ç« è®¿å®¢é‡ï¼š</strong>{{ site_info.contents_count }}</p>
                                            <p><strong>ç½‘ç«™è®¿å®¢é‡ï¼š</strong>{{ site_info.site_count }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h5><i class="fa fa-comment"></i> å…¬å‘Šä¸ç­¾å</h5>
                                            <p><strong>åšå®¢å…¬å‘Šï¼š</strong>{{ site_info.site_meg|default:"æš‚æ— å…¬å‘Š" }}</p>
                                            <p><strong>ä¸ªæ€§ç­¾åï¼š</strong>{{ site_info.signature|default:"æš‚æ— ç­¾å" }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="empty-state">
                                <i class="fa fa-info-circle"></i>
                                <h4>æš‚æ— ç½‘ç«™ä¿¡æ¯</h4>
                                <p>è¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜åˆå§‹åŒ–ç½‘ç«™ä¿¡æ¯</p>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
     <!-- æ·»åŠ å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div class="modal fade upload-modal" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="uploadModalLabel">æ·»åŠ æ–°å›¾ç‰‡</h4>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                            {% csrf_token %}

                        <!-- ä¸Šä¼ åŒºåŸŸ -->
                        <div class="upload-area">
                            <label for="imageUpload"
                                   style="display: block; cursor: pointer; padding: 40px 20px; margin: 0; text-align: center;">
                                <i>ğŸ“</i>
                                <h5>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</h5>
                                <p class="text-muted">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
                            </label>
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        </div>

                        <!-- å›¾ç‰‡é¢„è§ˆ -->
                        <div id="imagePreview" style="display: none; text-align: center; margin-bottom: 20px;">
                            <img id="previewImg" src="" alt="é¢„è§ˆå›¾" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                        </div>

                        <!-- è¡¨å•å­—æ®µ -->
                        <div class="form-group">
                            <label for="imageTitle">å›¾ç‰‡æ ‡é¢˜</label>
                            <input type="text" class="form-control" id="imageTitle" placeholder="è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜">
                        </div>

                        <div class="form-group">
                            <label for="imageDescription">å›¾ç‰‡æè¿°</label>
                            <textarea class="form-control" id="imageDescription" rows="3" placeholder="è¯·è¾“å…¥å›¾ç‰‡æè¿°..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="imageDate">æ‹æ‘„æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="imageDate">
                            <p style="font-size: 12px;color: red;">chromeä»¥å¤–æµè§ˆå™¨å¯èƒ½æ—¥æœŸæœ‰BUGï¼Œç‚¹å‡»å³ä¾§å°æ—¥å†é€‰æ‹©å³å¯</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveImageBtn">ä¿å­˜å›¾ç‰‡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡ç½®å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é‡ç½®ç”¨æˆ·å¯†ç </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" class="form-control" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" class="form-control" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="useDefaultPassword">
                    <label class="form-check-label" for="useDefaultPassword">ä½¿ç”¨é»˜è®¤å¯†ç  123456</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmResetBtn">ç¡®è®¤é‡ç½®</button>
            </div>
        </div>
    </div>
</div>

    <!-- åœ¨ç°æœ‰çš„æ¨¡æ€æ¡†åé¢æ·»åŠ  -->

    <!-- æ·»åŠ /ç¼–è¾‘å…¬å‘Šæ¨¡æ€æ¡† -->
    <div class="modal fade" id="announcementModal" tabindex="-1" role="dialog" aria-labelledby="announcementModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="announcementModalLabel">æ·»åŠ å…¬å‘Š</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="announcementForm">
                        {% csrf_token %}
                        <input type="hidden" id="announcementId" name="announcement_id">

                        <div class="form-group">
                            <label for="announcementVersion">ç‰ˆæœ¬å·</label>
                            <input type="text" class="form-control" id="announcementVersion"
                                   placeholder="è¯·è¾“å…¥ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼šv1.0.0ï¼‰" required>
                        </div>

                        <div class="form-group">
                            <label for="announcementContent">æ›´æ–°å†…å®¹</label>
                            <textarea class="form-control" id="announcementContent" rows="6"
                                      placeholder="è¯·è¾“å…¥è¯¦ç»†çš„æ›´æ–°å†…å®¹..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveAnnouncementBtn">ä¿å­˜å…¬å‘Š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç½‘ç«™ä¿¡æ¯ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="siteInfoModal" tabindex="-1" role="dialog" aria-labelledby="siteInfoModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="siteInfoModalLabel">ç¼–è¾‘ç½‘ç«™ä¿¡æ¯</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="siteInfoModalForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>ç®¡ç†å‘˜</label>
                            <input type="text" class="form-control" value="{{ site_info.admin.username }}" readonly>
                        </div>
                        <div class="form-group">
                            <label>æ–‡ç« æ€»æµè§ˆé‡</label>
                            <input type="text" class="form-control" value="{{ site_info.contents_count }} (è‡ªåŠ¨è®¡ç®—)" readonly>
                            <small class="form-text text-muted">æ­¤æ•°å€¼è‡ªåŠ¨ä»æ‰€æœ‰æ–‡ç« çš„æ€»æµè§ˆé‡è®¡ç®—å¾—å‡º</small>
                        </div>
                        <div class="form-group">
                            <label>ç½‘ç«™æ€»è®¿å®¢é‡</label>
                            <input type="text" class="form-control" value="{{ site_info.site_count }} (è‡ªåŠ¨ç»Ÿè®¡)" readonly>
                            <small class="form-text text-muted">æ­¤æ•°å€¼è‡ªåŠ¨ç»Ÿè®¡ç½‘ç«™è®¿é—®æ¬¡æ•°</small>
                        </div>
                        <div class="form-group">
                            <label for="modalSiteMeg">åšå®¢å…¬å‘Š</label>
                            <textarea class="form-control" id="modalSiteMeg" name="site_meg" rows="3"
                                      placeholder="è¯·è¾“å…¥åšå®¢å…¬å‘Šå†…å®¹">{{ site_info.site_meg }}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="modalSignature">ä¸ªæ€§ç­¾å</label>
                            <textarea class="form-control" id="modalSignature" name="signature" rows="2"
                                      placeholder="è¯·è¾“å…¥ä¸ªæ€§ç­¾å">{{ site_info.signature }}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveSiteInfoBtn">ä¿å­˜æ›´æ”¹</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
<script>
// å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
$(document).ready(function () {
            // ä¸Šä¼ å›¾ç‰‡åŠŸèƒ½
            $('#uploadArea').click(function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('#imageUpload').trigger('click'); // ç¡®ä¿è§¦å‘ç‚¹å‡»
            });

            // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
            $('#imageUpload').change(function(e) {
                var file = e.target.files[0];
                if (file) {
                    // æ–‡ä»¶ç±»å‹éªŒè¯
                    var validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                    if (!validTypes.includes(file.type)) {
                        alert('è¯·ä¸Šä¼  JPGã€PNG æˆ– GIF æ ¼å¼çš„å›¾ç‰‡');
                        $(this).val(''); // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                        return;
                    }

                    // æ–‡ä»¶å¤§å°éªŒè¯ (5MB)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                        $(this).val(''); // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                        return;
                    }

                    var reader = new FileReader();
                    reader.onload = function(e) {
                        $('#previewImg').attr('src', e.target.result);
                        $('#imagePreview').show();
                    }
                    reader.readAsDataURL(file);
                }
            });

            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            $('#uploadArea').on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).css({
                    'border-color': '#667eea',
                    'background-color': '#f8f9fa'
                });
            });

            $('#uploadArea').on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).css({
                    'border-color': '#ccc',
                    'background-color': 'transparent'
                });
            });

            $('#uploadArea').on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    $('#imageUpload')[0].files = files;
                    $('#imageUpload').trigger('change');
                }
                $(this).css({
                    'border-color': '#ccc',
                    'background-color': 'transparent'
                });
            });

            // ä¿å­˜å›¾ç‰‡åŠŸèƒ½ - ä½¿ç”¨AJAXä¸Šä¼ 
            $('#saveImageBtn').click(function(e) {
    e.preventDefault(); // ä½¿ç”¨ preventDefault è€Œä¸æ˜¯ stopPropagation

    var title = $('#imageTitle').val();
    var description = $('#imageDescription').val();
    var date = $('#imageDate').val();
    var file = $('#imageUpload')[0].files[0];

    if (!file) {
        alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡');
        return;
    }

    if (!title) {
        alert('è¯·è¾“å…¥å›¾ç‰‡æ ‡é¢˜');
        return;
    }

    // è·å– CSRF token
    var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

    // åˆ›å»ºFormDataå¯¹è±¡
    var formData = new FormData();
    formData.append('image', file);
    formData.append('title', title);
    formData.append('description', description);
    if (date) {
        formData.append('capture_date', date);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    var $btn = $(this);
    $btn.prop('disabled', true).text('ä¸Šä¼ ä¸­...');

    // AJAXä¸Šä¼ 
    $.ajax({
        url: '/upload_pic/',  // ç¡®ä¿è¿™ä¸ªURLæ­£ç¡®
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': csrfToken  // æ·»åŠ  CSRF token åˆ°è¯·æ±‚å¤´
        },
        success: function(response) {
            console.log('ä¸Šä¼ å“åº”:', response); // æ·»åŠ æ—¥å¿—
            if (response.status === 'success') {
                alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');
                $('#uploadModal').modal('hide');

                // é‡ç½®è¡¨å•
                $('#uploadForm')[0].reset();
                $('#imagePreview').hide();

                // å¯é€‰ï¼šåˆ·æ–°é¡µé¢æˆ–åŠ¨æ€æ·»åŠ æ–°å›¾ç‰‡
                location.reload(); // ç®€å•åˆ·æ–°é¡µé¢
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('ä¸Šä¼ é”™è¯¯:', error, xhr.responseText);
            alert('ä¸Šä¼ å‡ºé”™: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
        },
        complete: function() {
            $btn.prop('disabled', false).text('ä¿å­˜å›¾ç‰‡');
        }
    });
});
});
function editContent(id) {
    alert('ç¼–è¾‘æ–‡ç«  ID: ' + id);
    // è¿™é‡Œå¯ä»¥æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†æˆ–è·³è½¬åˆ°ç¼–è¾‘é¡µé¢
}

function deleteContent(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')) {
        $.ajax({
            url: '/admin/delete_content/' + id + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        });
    }
}

// ç”¨æˆ·ç®¡ç†å‡½æ•°
function editUser(id) {
    //id ç”¨æˆ· å‘åå°å‘é€ajaxçš„POSTè¯·æ±‚ï¼Œé‡ç½®å¯†ç 

}

function deleteUser(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) {
        $.ajax({
            url: '/admin/delete_user/' + id + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        });
    }
}

// ç•™è¨€ç®¡ç†å‡½æ•°
function deleteComment(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) {
        $.ajax({
            url: '/admin/delete_comment/' + id + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        });
    }
}

// å›¾ç‰‡ç®¡ç†å‡½æ•°
function showPictureForm() {
    alert('æ‰“å¼€æ·»åŠ å›¾ç‰‡è¡¨å•');
}

function deletePicture(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
        $.ajax({
            url: '/admin/delete_picture/' + id + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        });
    }
}

// å¼¹å¹•ç®¡ç†å‡½æ•°
function deleteLeaveMeg(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¼¹å¹•å—ï¼Ÿ')) {
        $.ajax({
            url: '/admin/delete_leavemeg/' + id + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        });
    }
}
// æ ‡ç­¾ç®¡ç†å‡½æ•°
function showTagForm() {
    const tagName = prompt('è¯·è¾“å…¥æ ‡ç­¾åç§°:');
    if (tagName && tagName.trim() !== '') {
        $.ajax({
            url: '/admin_user/add_tag/',
            type: 'POST',
            data: {
                'tag_name': tagName,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('æ·»åŠ å¤±è´¥');
                }
            }
        });
    }
}

function editTag(id) {
    // è·å–æ ‡ç­¾æ•°æ®
    $.ajax({
        url: '/admin/edit_tag/' + id + '/',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const tag = response.data;
                const newTagName = prompt('è¯·è¾“å…¥æ–°çš„æ ‡ç­¾åç§°:', tag.tag);

                if (newTagName && newTagName.trim() !== '') {
                    const formData = new FormData();
                    formData.append('tag_name', newTagName.trim());

                    $.ajax({
                        url: '/admin/edit_tag/' + id + '/',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.success) {
                                alert('æ ‡ç­¾æ›´æ–°æˆåŠŸ');
                                location.reload();
                            } else {
                                alert(response.message || 'æ›´æ–°å¤±è´¥');
                            }
                        }
                    });
                }
            } else {
                alert('è·å–æ ‡ç­¾æ•°æ®å¤±è´¥');
            }
        }
    });
}

function deleteTag(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡ç­¾å—ï¼Ÿ')) {
        $.ajax({
            url: '/admin_user/delete_tag/' + id + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        });
    }
}
{#é‡ç½®å¯†ç #}
let currentUserId = null;

function editUser(id) {
    currentUserId = id;
    $('#resetPasswordModal').modal('show');
}

$(document).ready(function() {
    // ä½¿ç”¨é»˜è®¤å¯†ç å¤é€‰æ¡†
    $('#useDefaultPassword').change(function() {
        if ($(this).is(':checked')) {
            $('#newPassword').val('123456').prop('disabled', true);
            $('#confirmPassword').val('123456').prop('disabled', true);
        } else {
            $('#newPassword').val('').prop('disabled', false);
            $('#confirmPassword').val('').prop('disabled', false);
        }
    });

    // ç¡®è®¤é‡ç½®å¯†ç 
    $('#confirmResetBtn').click(function() {
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmPassword').val();

        if (!newPassword) {
            alert('è¯·è¾“å…¥æ–°å¯†ç ');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
            return;
        }

        $.ajax({
            url: '/admin/reset_password/' + currentUserId + '/',
            type: 'POST',
            data: {
                'new_password': newPassword,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    alert('å¯†ç é‡ç½®æˆåŠŸï¼');
                    $('#resetPasswordModal').modal('hide');
                    // é‡ç½®è¡¨å•
                    $('#newPassword').val('');
                    $('#confirmPassword').val('');
                    $('#useDefaultPassword').prop('checked', false);
                } else {
                    alert('é‡ç½®å¤±è´¥: ' + response.message);
                }
            }
        });
    });
});

// å…¬å‘Šç®¡ç†å‡½æ•°
function showAnnouncementForm() {
    // é‡ç½®è¡¨å•
    $('#announcementForm')[0].reset();
    $('#announcementId').val('');
    $('#announcementModalLabel').text('æ·»åŠ å…¬å‘Š');
    $('#announcementModal').modal('show');
}

function editAnnouncement(id) {
    // è·å–å…¬å‘Šæ•°æ®
    $.ajax({
        url: '/admin/edit_announcement/' + id + '/',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const announcement = response.data;
                // å¡«å……è¡¨å•
                $('#announcementId').val(announcement.id);
                $('#announcementVersion').val(announcement.version);
                $('#announcementContent').val(announcement.content);
                $('#announcementModalLabel').text('ç¼–è¾‘å…¬å‘Š');
                $('#announcementModal').modal('show');
            } else {
                alert('è·å–å…¬å‘Šæ•°æ®å¤±è´¥');
            }
        },
        error: function() {
            alert('è·å–å…¬å‘Šæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯');
        }
    });
}

// ä¿å­˜å…¬å‘Š
$('#saveAnnouncementBtn').click(function() {
    const version = $('#announcementVersion').val().trim();
    const content = $('#announcementContent').val().trim();
    const announcementId = $('#announcementId').val();

    if (!version) {
        alert('è¯·è¾“å…¥ç‰ˆæœ¬å·');
        return;
    }

    if (!content) {
        alert('è¯·è¾“å…¥æ›´æ–°å†…å®¹');
        return;
    }

    const url = announcementId ?
        '/admin/edit_announcement/' + announcementId + '/' :
        '/admin/add_announcement/';

    const formData = new FormData();
    formData.append('version', version);
    formData.append('content', content);

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const $btn = $(this);
    $btn.prop('disabled', true).text('ä¿å­˜ä¸­...');

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert('å…¬å‘Šä¿å­˜æˆåŠŸï¼');
                $('#announcementModal').modal('hide');
                location.reload();
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            alert('ä¿å­˜æ—¶å‘ç”Ÿé”™è¯¯: ' + error);
        },
        complete: function() {
            $btn.prop('disabled', false).text('ä¿å­˜å…¬å‘Š');
        }
    });
});

function deleteAnnouncement(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿ')) {
        $.ajax({
            url: '/admin/delete_announcement/' + id + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            }
        });
    }
}

// ç½‘ç«™ä¿¡æ¯ç®¡ç†å‡½æ•°
function showSiteInfoForm() {
    $('#siteInfoModal').modal('show');
}

$('#saveSiteInfoBtn').click(function() {
    const formData = new FormData();
    formData.append('site_meg', $('#modalSiteMeg').val());
    formData.append('signature', $('#modalSignature').val());

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const $btn = $(this);
    $btn.prop('disabled', true).text('ä¿å­˜ä¸­...');

    $.ajax({
        url: '/admin/update_siteinfo/',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert('ç½‘ç«™ä¿¡æ¯æ›´æ–°æˆåŠŸï¼');
                $('#siteInfoModal').modal('hide');
                location.reload();
            } else {
                alert('æ›´æ–°å¤±è´¥: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            alert('æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯: ' + error);
        },
        complete: function() {
            $btn.prop('disabled', false).text('ä¿å­˜æ›´æ”¹');
        }
    });
});

</script>
{% endblock %}